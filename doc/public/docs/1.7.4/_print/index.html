<!doctype html>
<html lang="en" class="no-js">
  <head>
    <meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="generator" content="Hugo 0.111.2">
<link rel="canonical" type="text/html" href="/docs/1.7.4/">
<link rel="alternate" type="application/rss&#43;xml" href="/docs/1.7.4/index.xml">
<meta name="robots" content="noindex, nofollow">


<link rel="apple-touch-icon" sizes="57x57" href="https://apache.org/favicons/apple-touch-icon-57x57.png">
<link rel="apple-touch-icon" sizes="60x60" href="https://apache.org/favicons/apple-touch-icon-60x60.png">
<link rel="apple-touch-icon" sizes="72x72" href="https://apache.org/favicons/apple-touch-icon-72x72.png">
<link rel="apple-touch-icon" sizes="76x76" href="https://apache.org/favicons/apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" sizes="114x114" href="https://apache.org/favicons/apple-touch-icon-114x114.png">
<link rel="apple-touch-icon" sizes="120x120" href="https://apache.org/favicons/apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" sizes="144x144" href="https://apache.org/favicons/apple-touch-icon-144x144.png">
<link rel="apple-touch-icon" sizes="152x152" href="https://apache.org/favicons/apple-touch-icon-152x152.png">
<link rel="apple-touch-icon" sizes="180x180" href="https://apache.org/favicons/apple-touch-icon-180x180.png">
<link rel="icon" type="image/png" href="https://apache.org/favicons/favicon-32x32.png" sizes="32x32">
<link rel="icon" type="image/png" href="https://apache.org/favicons/favicon-194x194.png" sizes="194x194">
<link rel="icon" type="image/png" href="https://apache.org/favicons/favicon-96x96.png" sizes="96x96">
<link rel="icon" type="image/png" href="https://apache.org/favicons/android-chrome-192x192.png" sizes="192x192">
<link rel="icon" type="image/png" href="https://apache.org/favicons/favicon-16x16.png" sizes="16x16">
<link rel="manifest" href="https://apache.org/favicons/manifest.json">
<link rel="shortcut icon" href="https://apache.org/favicons/favicon.ico">

<title>Apache Avro™ 1.7.4 Documentation | Apache Avro</title>
<meta name="description" content="">
<meta property="og:title" content="Apache Avro™ 1.7.4 Documentation" />
<meta property="og:description" content="" />
<meta property="og:type" content="website" />
<meta property="og:url" content="/docs/1.7.4/" /><meta property="og:site_name" content="Apache Avro" />
<meta itemprop="name" content="Apache Avro™ 1.7.4 Documentation">
<meta itemprop="description" content=""><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="Apache Avro™ 1.7.4 Documentation"/>
<meta name="twitter:description" content=""/>




<link rel="preload" href="/scss/main.min.c8d1e8740b9f6b456ed100552e8c731d32c957ed3c5969d324484575041a0be1.css" as="style">
<link href="/scss/main.min.c8d1e8740b9f6b456ed100552e8c731d32c957ed3c5969d324484575041a0be1.css" rel="stylesheet" integrity="">

<script
  src="https://code.jquery.com/jquery-3.5.1.min.js"
  integrity="sha256-9/aliU8dGd2tb6OSsuzixeV4y/faTqgFtohetphbbj0="
  crossorigin="anonymous"></script>
<link rel="stylesheet" href="/css/prism.css"/>

  </head>
  <body class="td-section">
    <header>
      


<nav class="js-navbar-scroll navbar navbar-expand navbar-dark flex-column flex-md-row td-navbar">
        <a class="navbar-brand" href="/">

		<span class="navbar-logo"><img src="/docs/1.11.1/logo.svg" width="100" height="30" style="margin: 0 10px"></span><span class="text-uppercase font-weight-bold">Apache Avro</span>
	</a>

	<div class="td-navbar-nav-scroll ml-md-auto" id="main_navbar">
		<ul class="navbar-nav mt-2 mt-lg-0">
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Project
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/project/download/">Download</a>
	
	<a class="dropdown-item" href="/project/credits/">Credits</a>
	
	<a class="dropdown-item" href="/project/how-to-contribute/">How to Contribute</a>
	
	<a class="dropdown-item" href="https://www.apache.org/licenses/">License</a>
	
	<a class="dropdown-item" href="https://hadoop.apache.org/privacy_policy.html">Privacy Policy</a>
	
	<a class="dropdown-item" href="https://www.apache.org/security/">Security</a>
	
	<a class="dropdown-item" href="/project/events/">Events</a>
	
	<a class="dropdown-item" href="https://www.apache.org/foundation/sponsorship.html">Donate</a>
	
	<a class="dropdown-item" href="https://www.apache.org/foundation/thanks.html">Thanks</a>
	
</div>

			</li>
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Blog
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/blog/news/">News</a>
	
	<a class="dropdown-item" href="/blog/releases/">Releases</a>
	
</div>

			</li>
			
			<li class="nav-item mr-4 mb-2 mb-lg-0">
				
					
					
					
					
					
					
					
					
					<a class="nav-link" href="/community/" ><span>Community</span></a>
				
			</li>

			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	Documentation
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="/docs/1.11.1/">1.11.1 (Current)</a>
	
	<a class="dropdown-item" href="/docs/1.11.0/">1.11.0</a>
	
	<a class="dropdown-item" href="/docs/1.10.2/">1.10.2</a>
	
	<a class="dropdown-item" href="/docs/1.10.1/">1.10.1</a>
	
	<a class="dropdown-item" href="/docs/1.10.0/">1.10.0</a>
	
	<a class="dropdown-item" href="/docs/1.9.2/">1.9.2</a>
	
	<a class="dropdown-item" href="/docs/1.9.1/">1.9.1</a>
	
	<a class="dropdown-item" href="/docs/1.9.0/">1.9.0</a>
	
	<a class="dropdown-item" href="/docs/1.8.2/">1.8.2</a>
	
	<a class="dropdown-item" href="/docs/1.8.1/">1.8.1</a>
	
	<a class="dropdown-item" href="/docs/1.8.0/">1.8.0</a>
	
	<a class="dropdown-item" href="docs/1.7.7/">1.7.7</a>
	
	<a class="dropdown-item" href="/docs/1.7.6/">1.7.6</a>
	
	<a class="dropdown-item" href="/docs/1.7.5/">1.7.5</a>
	
	<a class="dropdown-item" href="/docs/1.7.4/">1.7.4</a>
	
	<a class="dropdown-item" href="/docs/1.7.3/">1.7.3</a>
	
	<a class="dropdown-item" href="/docs/1.7.2/">1.7.2</a>
	
	<a class="dropdown-item" href="/docs/1.7.1/">1.7.1</a>
	
	<a class="dropdown-item" href="/docs/1.7.0/">1.7.0</a>
	
	<a class="dropdown-item" href="/docs/1.6.3/">1.6.3</a>
	
	<a class="dropdown-item" href="/docs/1.6.2/">1.6.2</a>
	
	<a class="dropdown-item" href="/docs/1.6.1/">1.6.1</a>
	
	<a class="dropdown-item" href="/docs/1.6.0/">1.6.0</a>
	
	<a class="dropdown-item" href="/docs/1.5.4/">1.5.4</a>
	
	<a class="dropdown-item" href="/docs/1.5.3/">1.5.3</a>
	
	<a class="dropdown-item" href="/docs/1.5.2/">1.5.2</a>
	
	<a class="dropdown-item" href="/docs/1.5.1/">1.5.1</a>
	
	<a class="dropdown-item" href="/docs/1.5.0/">1.5.0</a>
	
	<a class="dropdown-item" href="/docs/1.4.1/">1.4.1</a>
	
	<a class="dropdown-item" href="/docs/1.4.0/">1.4.0</a>
	
	<a class="dropdown-item" href="/docs/1.3.3/">1.3.3</a>
	
	<a class="dropdown-item" href="/docs/1.3.2/">1.3.2</a>
	
	<a class="dropdown-item" href="/docs/1.3.1/">1.3.1</a>
	
	<a class="dropdown-item" href="/docs/1.3.0/">1.3.0</a>
	
	<a class="dropdown-item" href="/docs/1.2.0/">1.2.0</a>
	
	<a class="dropdown-item" href="/docs/1.1.0/">1.1.0</a>
	
	<a class="dropdown-item" href="/docs/1.0.0/">1.0.0</a>
	
</div>

			</li>
			<li class="nav-item dropdown mr-4 d-none d-lg-block">
				

<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	ASF links
</a>
<div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
	
	<a class="dropdown-item" href="http://www.apache.org/" target="_blank">ASF Web Site</a>
	
	<a class="dropdown-item" href="http://www.apache.org/licenses/" target="_blank">License</a>
	
	<a class="dropdown-item" href="http://www.apache.org/foundation/sponsorship.html" target="_blank">Donate</a>
	
	<a class="dropdown-item" href="http://www.apache.org/foundation/thanks.html" target="_blank">Thanks</a>
	
	<a class="dropdown-item" href="http://www.apache.org/security/" target="_blank">Security</a>
	
</div>

			</li>
			
		</ul>
	</div>
	<div class="navbar-nav d-none d-lg-block"></div>
</nav>

    </header>
    <div class="container-fluid td-outer">
      <div class="td-main">
        <div class="row flex-xl-nowrap">
          <main class="col-12 col-md-9 col-xl-8 pl-md-5" role="main">
            




<div class="td-content">
<div class="pageinfo pageinfo-primary d-print-none">
<p>
This is the multi-page printable view of this section.
<a href="#" onclick="print();return false;">Click here to print</a>.
</p><p>
<a href="/docs/1.7.4/">Return to the regular view of this page</a>.
</p>
</div>



<h1 class="title">Apache Avro™ 1.7.4 Documentation</h1>





    <ul>
    
  
  
  
  

  
    
    
	
<li>1: <a href="#pg-10f364484aa5e5d3b58ee28e64ba0ff6">Getting Started (Java)</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>2: <a href="#pg-ef0b7097ca442ff9a9db74acf9460fb5">Getting Started (Python)</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>3: <a href="#pg-0d8a49e5eb51a911cc056ad2f4777dc9">Specification</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>4: <a href="#pg-587b98bca97043e057c22ee05fcc9146">Trevni</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>5: <a href="#pg-e82727a687286aede19db3df523a207a">MapReduce guide</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>6: <a href="#pg-7c053ceb7ab566384ea3cf84bbf5dd53">IDL Language</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>7: <a href="#pg-4b8d3266c94eea5257ceff0ddb5b9b56">SASL profile</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>8: <a href="#pg-fb10f23b4405ac464a4717347b11735f">Wiki</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  
    
    
	
<li>9: <a href="#pg-c6272d220cb97ce59bb49530b65880bf">FAQ</a></li>


    
    <ul>
        
  
  
  
  

  

    </ul>
    
  

    </ul>


<div class="content">
      <!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="introduction">Introduction</h2>
<p>Apache Avro™ is a data serialization system.</p>
<p>Avro provides:</p>
<ul>
<li>Rich data structures.</li>
<li>A compact, fast, binary data format.</li>
<li>A container file, to store persistent data.</li>
<li>Remote procedure call (RPC).</li>
<li>Simple integration with dynamic languages. Code generation is not required to read or write data files nor to use or implement RPC protocols. Code generation as an optional optimization, only worth implementing for statically typed languages.</li>
</ul>
<h2 id="schemas">Schemas</h2>
<p>Avro relies on schemas. When Avro data is read, the schema used when writing it is always present. This permits each datum to be written with no per-value overheads, making serialization both fast and small. This also facilitates use with dynamic, scripting languages, since data, together with its schema, is fully self-describing.</p>
<p>When Avro data is stored in a file, its schema is stored with it, so that files may be processed later by any program. If the program reading the data expects a different schema this can be easily resolved, since both schemas are present.</p>
<p>When Avro is used in RPC, the client and server exchange schemas in the connection handshake. (This can be optimized so that, for most calls, no schemas are actually transmitted.) Since both client and server both have the other&rsquo;s full schema, correspondence between same named fields, missing fields, extra fields, etc. can all be easily resolved.</p>
<p>Avro schemas are defined with JSON . This facilitates implementation in languages that already have JSON libraries.</p>
<h2 id="comparison-with-other-systems">Comparison with other systems</h2>
<p>Avro provides functionality similar to systems such as <a href="https://thrift.apache.org/">Thrift</a>, <a href="https://code.google.com/p/protobuf/">Protocol Buffers</a>, etc. Avro differs from these systems in the following fundamental aspects.</p>
<ul>
<li>Dynamic typing: Avro does not require that code be generated. Data is always accompanied by a schema that permits full processing of that data without code generation, static datatypes, etc. This facilitates construction of generic data-processing systems and languages.</li>
<li>Untagged data: Since the schema is present when data is read, considerably less type information need be encoded with data, resulting in smaller serialization size.</li>
<li>No manually-assigned field IDs: When a schema changes, both the old and new schema are always present when processing data, so differences may be resolved symbolically, using field names.</li>
</ul>
<p>Apache Avro, Avro, Apache, and the Avro and Apache logos are trademarks of The Apache Software Foundation.</p>

</div>
</div>


  
  
  
  

  
  

  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-10f364484aa5e5d3b58ee28e64ba0ff6">1 - Getting Started (Java)</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<p>This is a short guide for getting started with Apache Avro™ using Java. This guide only covers using Avro for data serialization; see Patrick Hunt&rsquo;s <a href="https://github.com/phunt/avro-rpc-quickstart">Avro RPC Quick Start</a> for a good introduction to using Avro for RPC.</p>
<h2 id="download">Download</h2>
<p>Avro implementations for C, C++, C#, Java, PHP, Python, and Ruby can be downloaded from the Apache Avro™ Releases page. This guide uses Avro 1.7.4, the latest version at the time of writing. For the examples in this guide, download avro-1.7.4.jar and avro-tools-1.7.4.jar. The Avro Java implementation also depends on the Jackson JSON library. From the Jackson download page, download the core-asl and mapper-asl jars. Add avro-1.7.4.jar and the Jackson jars to your project&rsquo;s classpath (avro-tools will be used for code generation).</p>
<p>Alternatively, if you are using Maven, add the following dependency to your POM:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.7.4<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>As well as the Avro Maven plugin (for performing code generation):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-maven-plugin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.7.4<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;phase&gt;</span>generate-sources<span style="color:#204a87;font-weight:bold">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;goal&gt;</span>schema<span style="color:#204a87;font-weight:bold">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;sourceDirectory&gt;</span>${project.basedir}/src/main/avro/<span style="color:#204a87;font-weight:bold">&lt;/sourceDirectory&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;outputDirectory&gt;</span>${project.basedir}/src/main/java/<span style="color:#204a87;font-weight:bold">&lt;/outputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.maven.plugins<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>maven-compiler-plugin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;source&gt;</span>1.6<span style="color:#204a87;font-weight:bold">&lt;/source&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;target&gt;</span>1.6<span style="color:#204a87;font-weight:bold">&lt;/target&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>You may also build the required Avro jars from source. Building Avro is beyond the scope of this guide; see the <a href="https://cwiki.apache.org/confluence/display/AVRO/Build+Documentation">Build Documentation</a> page in the wiki for more information.</p>
<h2 id="defining-a-schema">Defining a schema</h2>
<p>Avro schemas are defined using JSON. Schemas are composed of <a href="https://avro.apache.org/docs/1.7.4/spec.html#schema_primitive">primitive types</a> (null, boolean, int, long, float, double, bytes, and string) and <a href="https://avro.apache.org/docs/1.7.4/spec.html#schema_complex">complex types</a> (record, enum, array, map, union, and fixed). You can learn more about Avro schemas and types from the specification, but for now let&rsquo;s start with a simple schema example, user.avsc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example.avro&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This schema defines a record representing a hypothetical user. (Note that a schema file can only contain a single schema definition.) At minimum, a record definition must include its type (&ldquo;type&rdquo;: &ldquo;record&rdquo;), a name (&ldquo;name&rdquo;: &ldquo;User&rdquo;), and fields, in this case name, favorite_number, and favorite_color. We also define a namespace (&ldquo;namespace&rdquo;: &ldquo;example.avro&rdquo;), which together with the name attribute defines the &ldquo;full name&rdquo; of the schema (example.avro.User in this case).</p>
<p>Fields are defined via an array of objects, each of which defines a name and type (other attributes are optional, see the <a href="https://avro.apache.org/docs/1.7.4/spec.html#schema_record">record specification</a> for more details). The type attribute of a field is another schema object, which can be either a primitive or complex type. For example, the name field of our User schema is the primitive type string, whereas the favorite_number and favorite_color fields are both unions, represented by JSON arrays. unions are a complex type that can be any of the types listed in the array; e.g., favorite_number can either be an int or null, essentially making it an optional field.</p>
<h2 id="serializing-and-deserializing-with-code-generation">Serializing and deserializing with code generation</h2>
<h3 id="compiling-the-schema">Compiling the schema</h3>
<p>Code generation allows us to automatically create classes based on our previously-defined schema. Once we have defined the relevant classes, there is no need to use the schema directly in our programs. We use the avro-tools jar to generate code as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>java -jar /path/to/avro-tools-1.7.4.jar compile schema &lt;schema file&gt; &lt;destination&gt;
</span></span></code></pre></div><p>This will generate the appropriate source files in a package based on the schema&rsquo;s namespace in the provided destination folder. For instance, to generate a User class in package example.avro from the schema defined above, run</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>java -jar /path/to/avro-tools-1.7.4.jar compile schema user.avsc .
</span></span></code></pre></div><p>Note that if you using the Avro Maven plugin, there is no need to manually invoke the schema compiler; the plugin automatically performs code generation on any .avsc files present in the configured source directory.</p>
<h3 id="creating-users">Creating Users</h3>
<p>Now that we&rsquo;ve completed the code generation, let&rsquo;s create some Users, serialize them to a data file on disk, and then read back the file and deserialize the User objects.</p>
<p>First let&rsquo;s create some Users and set their fields.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">User</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setFavoriteNumber</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Leave favorite color null
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Alternate constructor
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">User</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Construct via builder
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">User</span> <span style="color:#000">user3</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">newBuilder</span><span style="color:#ce5c00;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>             <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Charlie&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>             <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>             <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setFavoriteNumber</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>             <span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">build</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span></code></pre></div><p>As shown in this example, Avro objects can be created either by invoking a constructor directly or by using a builder. Unlike constructors, builders will automatically set any default values specified in the schema. Additionally, builders validate the data as it set, whereas objects constructed directly will not cause an error until the object is serialized. However, using constructors directly generally offers better performance, as builders create a copy of the datastructure before it is written.</p>
<p>Note that we do not set user1&rsquo;s favorite color. Since that record is of type [&ldquo;string&rdquo;, &ldquo;null&rdquo;], we can either set it to a string or leave it null; it is essentially optional. Similarly, we set user3&rsquo;s favorite number to null (using a builder requires setting all fields, even if they are null).</p>
<h3 id="serializing">Serializing</h3>
<p>Now let&rsquo;s serialize our Users to disk.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Serialize user1 and user2 to disk
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">File</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DatumWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">userDatumWriter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SpecificDatumWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DataFileWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">dataFileWriter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DataFileWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">userDatumWriter</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getSchema</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">append</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">append</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user2</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">append</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user3</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">close</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span></code></pre></div><p>We create a DatumWriter, which converts Java objects into an in-memory serialized format. The SpecificDatumWriter class is used with generated classes and extracts the schema from the specified generated type.</p>
<p>Next we create a DataFileWriter, which writes the serialized records, as well as the schema, to the file specified in the dataFileWriter.create call. We write our users to the file via calls to the dataFileWriter.append method. When we are done writing, we close the data file.</p>
<h3 id="deserializing">Deserializing</h3>
<p>Finally, let&rsquo;s deserialize the data file we just created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Deserialize Users from disk
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">DatumReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">userDatumReader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">SpecificDatumReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DataFileReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">dataFileReader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DataFileReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">userDatumReader</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">User</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">dataFileReader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasNext</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reuse user object by passing it to next(). This saves us from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// allocating and garbage collecting many objects for files with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// many items.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dataFileReader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">next</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>This snippet will output:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Charlie&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Deserializing is very similar to serializing. We create a SpecificDatumReader, analogous to the SpecificDatumWriter we used in serialization, which converts in-memory serialized items into instances of our generated class, in this case User. We pass the DatumReader and the previously created File to a DataFileReader, analogous to the DataFileWriter, which reads the data file on disk.</p>
<p>Next we use the DataFileReader to iterate through the serialized Users and print the deserialized object to stdout. Note how we perform the iteration: we create a single User object which we store the current deserialized user in, and pass this record object to every call of dataFileReader.next. This is a performance optimization that allows the DataFileReader to reuse the same User object rather than allocating a new User for every iteration, which can be very expensive in terms of object allocation and garbage collection if we deserialize a large data file. While this technique is the standard way to iterate through a data file, it&rsquo;s also possible to use for (User user : dataFileReader) if performance is not a concern.</p>
<h3 id="compiling-and-running-the-example-code">Compiling and running the example code</h3>
<p>This example code is included as a Maven project in the examples/java-example directory in the Avro docs. From this directory, execute the following commands to build and run the example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mvn compile <span style="color:#8f5902;font-style:italic"># includes code generation via Avro Maven plugin</span>
</span></span><span style="display:flex;"><span>$ mvn -q exec:java -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.SpecificMain
</span></span></code></pre></div><h2 id="serializing-and-deserializing-without-code-generation">Serializing and deserializing without code generation</h2>
<p>Data in Avro is always stored with its corresponding schema, meaning we can always read a serialized item regardless of whether we know the schema ahead of time. This allows us to perform serialization and deserialization without code generation.</p>
<p>Let&rsquo;s go over the same example as in the previous section, but without using code generation: we&rsquo;ll create some users, serialize them to a data file on disk, and then read back the file and deserialize the users objects.</p>
<h3 id="creating-users-1">Creating users</h3>
<p>First, we use a Parser to read our schema definition and create a Schema object.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">Schema</span> <span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Parser</span><span style="color:#ce5c00;font-weight:bold">().</span><span style="color:#c4a000">parse</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.avsc&#34;</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span></code></pre></div><p>Using this schema, let&rsquo;s create some users.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">GenericRecord</span> <span style="color:#000">user1</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GenericData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Record</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Leave favorite color null
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span><span style="color:#000">GenericRecord</span> <span style="color:#000">user2</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GenericData</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">Record</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">user2</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">put</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p>Since we&rsquo;re not using code generation, we use GenericRecords to represent users. GenericRecord uses the schema to verify that we only specify valid fields. If we try to set a non-existent field (e.g., user1.put(&ldquo;favorite_animal&rdquo;, &ldquo;cat&rdquo;)), we&rsquo;ll get an AvroRuntimeException when we run the program.</p>
<p>Note that we do not set user1&rsquo;s favorite color. Since that record is of type [&ldquo;string&rdquo;, &ldquo;null&rdquo;], we can either set it to a string or leave it null; it is essentially optional.</p>
<h3 id="serializing-1">Serializing</h3>
<p>Now that we&rsquo;ve created our user objects, serializing and deserializing them is almost identical to the example above which uses code generation. The main difference is that we use generic instead of specific readers and writers.</p>
<p>First we&rsquo;ll serialize our users to a data file on disk.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Serialize user1 and user2 to disk
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">File</span> <span style="color:#000">file</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">File</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DatumWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">datumWriter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GenericDatumWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DataFileWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">dataFileWriter</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DataFileWriter</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">datumWriter</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">append</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user1</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">append</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user2</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">dataFileWriter</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">close</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span></code></pre></div><p>We create a DatumWriter, which converts Java objects into an in-memory serialized format. Since we are not using code generation, we create a GenericDatumWriter. It requires the schema both to determine how to write the GenericRecords and to verify that all non-nullable fields are present.</p>
<p>As in the code generation example, we also create a DataFileWriter, which writes the serialized records, as well as the schema, to the file specified in the dataFileWriter.create call. We write our users to the file via calls to the dataFileWriter.append method. When we are done writing, we close the data file.</p>
<h3 id="deserializing-1">Deserializing</h3>
<p>Finally, we&rsquo;ll deserialize the data file we just created.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Deserialize users from disk
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">DatumReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">datumReader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">GenericDatumReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">DataFileReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">dataFileReader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">DataFileReader</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">GenericRecord</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">file</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">datumReader</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">GenericRecord</span> <span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">while</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">dataFileReader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">hasNext</span><span style="color:#ce5c00;font-weight:bold">())</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// Reuse user object by passing it to next(). This saves us from
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// allocating and garbage collecting many objects for files with
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">// many items.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span><span style="color:#000">user</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">dataFileReader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">next</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">out</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p>This outputs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Deserializing is very similar to serializing. We create a GenericDatumReader, analogous to the GenericDatumWriter we used in serialization, which converts in-memory serialized items into GenericRecords. We pass the DatumReader and the previously created File to a DataFileReader, analogous to the DataFileWriter, which reads the data file on disk.</p>
<p>Next, we use the DataFileReader to iterate through the serialized users and print the deserialized object to stdout. Note how we perform the iteration: we create a single GenericRecord object which we store the current deserialized user in, and pass this record object to every call of dataFileReader.next. This is a performance optimization that allows the DataFileReader to reuse the same record object rather than allocating a new GenericRecord for every iteration, which can be very expensive in terms of object allocation and garbage collection if we deserialize a large data file. While this technique is the standard way to iterate through a data file, it&rsquo;s also possible to use for (GenericRecord user : dataFileReader) if performance is not a concern.</p>
<h3 id="compiling-and-running-the-example-code-1">Compiling and running the example code</h3>
<p>This example code is included as a Maven project in the examples/java-example directory in the Avro docs. From this directory, execute the following commands to build and run the example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ mvn compile
</span></span><span style="display:flex;"><span>$ mvn -q exec:java -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.GenericMain
</span></span></code></pre></div>
</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-ef0b7097ca442ff9a9db74acf9460fb5">2 - Getting Started (Python)</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<p>This is a short guide for getting started with Apache Avro™ using Python. This guide only covers using Avro for data serialization; see Patrick Hunt&rsquo;s Avro RPC Quick Start for a good introduction to using Avro for RPC.</p>
<h2 id="download">Download</h2>
<p>Avro implementations for C, C++, C#, Java, PHP, Python, and Ruby can be downloaded from the Apache Avro™ Releases page. This guide uses Avro 1.7.4, the latest version at the time of writing. Download and unzip avro-1.7.4.tar.gz, and install via python setup.py (this will probably require root privileges). Ensure that you can import avro from a Python prompt.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ tar xvf avro-1.7.4.tar.gz
</span></span><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> avro-1.7.4
</span></span><span style="display:flex;"><span>$ sudo python setup.py install
</span></span><span style="display:flex;"><span>$ python
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; import avro <span style="color:#8f5902;font-style:italic"># should not raise ImportError</span>
</span></span></code></pre></div><p>Alternatively, you may build the Avro Python library from source. From your the root Avro directory, run the commands</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ <span style="color:#204a87">cd</span> lang/py/
</span></span><span style="display:flex;"><span>$ ant
</span></span><span style="display:flex;"><span>$ sudo python setup.py install
</span></span><span style="display:flex;"><span>$ python
</span></span><span style="display:flex;"><span>&gt;&gt;&gt; import avro <span style="color:#8f5902;font-style:italic"># should not raise ImportError</span>
</span></span></code></pre></div><h2 id="defining-a-schema">Defining a schema</h2>
<p>Avro schemas are defined using JSON. Schemas are composed of primitive types (null, boolean, int, long, float, double, bytes, and string) and complex types (record, enum, array, map, union, and fixed). You can learn more about Avro schemas and types from the specification, but for now let&rsquo;s start with a simple schema example, user.avsc:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example.avro&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This schema defines a record representing a hypothetical user. (Note that a schema file can only contain a single schema definition.) At minimum, a record definition must include its type (&ldquo;type&rdquo;: &ldquo;record&rdquo;), a name (&ldquo;name&rdquo;: &ldquo;User&rdquo;), and fields, in this case name, favorite_number, and favorite_color. We also define a namespace (&ldquo;namespace&rdquo;: &ldquo;example.avro&rdquo;), which together with the name attribute defines the &ldquo;full name&rdquo; of the schema (example.avro.User in this case).</p>
<p>Fields are defined via an array of objects, each of which defines a name and type (other attributes are optional, see the record specification for more details). The type attribute of a field is another schema object, which can be either a primitive or complex type. For example, the name field of our User schema is the primitive type string, whereas the favorite_number and favorite_color fields are both unions, represented by JSON arrays. unions are a complex type that can be any of the types listed in the array; e.g., favorite_number can either be an int or null, essentially making it an optional field.</p>
<h2 id="serializing-and-deserializing-without-code-generation">Serializing and deserializing without code generation</h2>
<p>Data in Avro is always stored with its corresponding schema, meaning we can always read a serialized item, regardless of whether we know the schema ahead of time. This allows us to perform serialization and deserialization without code generation. Note that the Avro Python library does not support code generation.</p>
<p>Try running the following code snippet, which serializes two users to a data file on disk, and then reads back and deserializes the data file:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">avro.schema</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">avro.datafile</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">DataFileReader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">DataFileWriter</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">from</span> <span style="color:#000">avro.io</span> <span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">DatumReader</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000">DatumWriter</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.avsc&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">read</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">writer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataFileWriter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;w&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">DatumWriter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">writer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">({</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">writer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">({</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">writer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">reader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataFileReader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">DatumReader</span><span style="color:#000;font-weight:bold">())</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">user</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">reader</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span> <span style="color:#000">user</span>
</span></span><span style="display:flex;"><span><span style="color:#000">reader</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">close</span><span style="color:#000;font-weight:bold">()</span>
</span></span></code></pre></div><p>This outputs:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">u&#39;favorite_color&#39;:</span> <span style="color:#a40000">None,</span> <span style="color:#a40000">u&#39;favorite_number&#39;:</span> <span style="color:#a40000">256,</span> <span style="color:#a40000">u&#39;name&#39;:</span> <span style="color:#a40000">u&#39;Alyssa&#39;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#a40000">u&#39;favorite_color&#39;:</span> <span style="color:#a40000">u&#39;red&#39;,</span> <span style="color:#a40000">u&#39;favorite_number&#39;:</span> <span style="color:#a40000">7,</span> <span style="color:#a40000">u&#39;name&#39;:</span> <span style="color:#a40000">u&#39;Ben&#39;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Let&rsquo;s take a closer look at what&rsquo;s going on here.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">schema</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">avro</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">parse</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;user.avsc&#34;</span><span style="color:#000;font-weight:bold">)</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">read</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>avro.schema.parse takes a string containing a JSON schema definition as input and outputs a avro.schema.Schema object (specifically a subclass of Schema, in this case RecordSchema). We&rsquo;re passing in the contents of our user.avsc schema file here.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">writer</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataFileWriter</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;w&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">DatumWriter</span><span style="color:#000;font-weight:bold">(),</span> <span style="color:#000">schema</span><span style="color:#000;font-weight:bold">)</span>
</span></span></code></pre></div><p>We create a DataFileWriter, which we&rsquo;ll use to write serialized items to a data file on disk. The DataFileWriter constructor takes three arguments:</p>
<ul>
<li>The file we&rsquo;ll serialize to</li>
<li>A DatumWriter, which is responsible for actually serializing the items to Avro&rsquo;s binary format (DatumWriters can be used separately from DataFileWriters, e.g., to perform IPC with Avro TODO: is this true??).</li>
<li>The schema we&rsquo;re using. The DataFileWriter needs the schema both to write the schema to the data file, and to verify that the items we write are valid items and write the appropriate fields.</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">writer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">({</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Alyssa&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#000;font-weight:bold">})</span>
</span></span><span style="display:flex;"><span><span style="color:#000">writer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#000">append</span><span style="color:#000;font-weight:bold">({</span><span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Ben&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">7</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">})</span>
</span></span></code></pre></div><p>We use DataFileWriter.append to add items to our data file. Avro records are represented as Python dicts. Since the field favorite_color has type [&ldquo;int&rdquo;, &ldquo;null&rdquo;], we are not required to specify this field, as shown in the first append. Were we to omit the required name field, an exception would be raised. Any extra entries not corresponding to a field are present in the dict are ignored.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#000">reader</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">DataFileReader</span><span style="color:#000;font-weight:bold">(</span><span style="color:#204a87">open</span><span style="color:#000;font-weight:bold">(</span><span style="color:#4e9a06">&#34;users.avro&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;r&#34;</span><span style="color:#000;font-weight:bold">),</span> <span style="color:#000">DatumReader</span><span style="color:#000;font-weight:bold">())</span>
</span></span></code></pre></div><p>We open the file again, this time for reading back from disk. We use a DataFileReader and DatumReader analagous to the DataFileWriter and DatumWriter above.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-python" data-lang="python"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">for</span> <span style="color:#000">user</span> <span style="color:#204a87;font-weight:bold">in</span> <span style="color:#000">reader</span><span style="color:#000;font-weight:bold">:</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87">print</span> <span style="color:#000">user</span>
</span></span></code></pre></div><p>The DataFileReader is an iterator that returns dicts corresponding to the serialized items.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-0d8a49e5eb51a911cc056ad2f4777dc9">3 - Specification</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="introduction">Introduction</h2>
<p>This document defines Apache Avro. It is intended to be the authoritative specification. Implementations of Avro must adhere to this document.</p>
<h2 id="schema-declaration">Schema Declaration</h2>
<p>A Schema is represented in <a href="https://www.json.org/">JSON</a> by one of:</p>
<ul>
<li>A JSON string, naming a defined type.</li>
<li>A JSON object, of the form:</li>
</ul>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-js" data-lang="js"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#4e9a06">&#34;type&#34;</span><span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;typeName&#34;</span> <span style="color:#000;font-weight:bold">...</span><span style="color:#000">attributes</span><span style="color:#000;font-weight:bold">...}</span>
</span></span></code></pre></div><p>where <em>typeName</em> is either a primitive or derived type name, as defined below. Attributes not defined in this document are permitted as metadata, but must not affect the format of serialized data.</p>
<ul>
<li>A JSON array, representing a union of embedded types.</li>
</ul>
<h2 id="primitive-types">Primitive Types</h2>
<p>The set of primitive type names is:</p>
<ul>
<li><em>null</em>: no value</li>
<li><em>boolean</em>: a binary value</li>
<li><em>int</em>: 32-bit signed integer</li>
<li><em>long</em>: 64-bit signed integer</li>
<li><em>float</em>: single precision (32-bit) IEEE 754 floating-point number</li>
<li><em>double</em>: double precision (64-bit) IEEE 754 floating-point number</li>
<li><em>bytes</em>: sequence of 8-bit unsigned bytes</li>
<li><em>string</em>: unicode character sequence</li>
</ul>
<p>Primitive types have no specified attributes.</p>
<p>Primitive type names are also defined type names. Thus, for example, the schema &ldquo;string&rdquo; is equivalent to:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="complex-types">Complex Types</h2>
<p>Avro supports six kinds of complex types: <em>records</em>, <em>enums</em>, <em>arrays</em>, <em>maps</em>, <em>unions</em> and <em>fixed</em>.</p>
<h3 id="schema-record">Records</h3>
<p>Records use the type name &ldquo;record&rdquo; and support three attributes:</p>
<ul>
<li><em>name</em>: a JSON string providing the name of the record (required).</li>
<li><em>namespace</em>, a JSON string that qualifies the name;</li>
<li><em>doc</em>: a JSON string providing documentation to the user of this schema (optional).</li>
<li><em>aliases</em>: a JSON array of strings, providing alternate names for this record (optional).</li>
<li><em>fields</em>: a JSON array, listing fields (required). Each field is a JSON object with the following attributes:
<ul>
<li><em>name</em>: a JSON string providing the name of the field (required), and</li>
<li><em>doc</em>: a JSON string describing this field for users (optional).</li>
<li><em>type</em>:  A JSON object defining a schema, or a JSON string naming a record definition (required).</li>
<li>_default: A default value for this field, used when reading instances that lack this field (optional). Permitted values depend on the field&rsquo;s schema type, according to the table below. Default values for union fields correspond to the first schema in the union. Default values for bytes and fixed fields are JSON strings, where Unicode code points 0-255 are mapped to unsigned 8-bit byte values 0-255.</li>
</ul>
</li>
</ul>
<p><em>field default values</em></p>
<table>
<thead>
<tr>
<th><strong>avro type</strong></th>
<th><strong>json type</strong></th>
<th><strong>example</strong></th>
</tr>
</thead>
<tbody>
<tr>
<td>null</td>
<td>null</td>
<td><code>null</code></td>
</tr>
<tr>
<td>boolean</td>
<td>boolean</td>
<td><code>true</code></td>
</tr>
<tr>
<td>int,long</td>
<td>integer</td>
<td><code>1</code></td>
</tr>
<tr>
<td>float,double</td>
<td>number</td>
<td><code>1.1</code></td>
</tr>
<tr>
<td>bytes</td>
<td>string</td>
<td><code>&quot;\u00FF&quot;</code></td>
</tr>
<tr>
<td>string</td>
<td>string</td>
<td><code>&quot;foo&quot;</code></td>
</tr>
<tr>
<td>record</td>
<td>object</td>
<td><code>{&quot;a&quot;: 1}</code></td>
</tr>
<tr>
<td>enum</td>
<td>string</td>
<td><code>&quot;FOO&quot;</code></td>
</tr>
<tr>
<td>array</td>
<td>array</td>
<td><code>[1]</code></td>
</tr>
<tr>
<td>map</td>
<td>object</td>
<td><code>{&quot;a&quot;: 1}</code></td>
</tr>
<tr>
<td>fixed</td>
<td>string</td>
<td><code>&quot;\u00ff&quot;</code></td>
</tr>
</tbody>
</table>
<ul>
<li><em>order</em>: specifies how this field impacts sort ordering of this record (optional). Valid values are &ldquo;ascending&rdquo; (the default), &ldquo;descending&rdquo;, or &ldquo;ignore&rdquo;. For more details on how this is used, see the sort order section below.</li>
<li><em>aliases</em>: a JSON array of strings, providing alternate names for this field (optional).</li>
</ul>
<p>For example, a linked-list of 64-bit values may be defined with:</p>
<pre tabindex="0"><code class="language-jsonc" data-lang="jsonc">{
  &#34;type&#34;: &#34;record&#34;,
  &#34;name&#34;: &#34;LongList&#34;,
  &#34;aliases&#34;: [&#34;LinkedLongs&#34;],                      // old name for this
  &#34;fields&#34; : [
    {&#34;name&#34;: &#34;value&#34;, &#34;type&#34;: &#34;long&#34;},             // each element has a long
    {&#34;name&#34;: &#34;next&#34;, &#34;type&#34;: [&#34;LongList&#34;, &#34;null&#34;]} // optional next element
  ]
}
</code></pre><h3 id="enums">Enums</h3>
<p>Enums use the type name &ldquo;enum&rdquo; and support the following attributes:</p>
<ul>
<li><em>name</em>: a JSON string providing the name of the enum (required).</li>
<li><em>namespace</em>, a JSON string that qualifies the name ;</li>
<li><em>aliases</em>: a JSON array of strings, providing alternate names for this enum (optional).</li>
<li><em>doc</em>: a JSON string providing documentation to the user of this schema (optional).</li>
<li><em>symbols</em>: a JSON array, listing symbols, as JSON strings (required). All symbols in an enum must be unique; duplicates are prohibited.</li>
</ul>
<p>For example, playing card suits might be defined with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Suit&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;symbols&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;SPADES&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;HEARTS&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;DIAMONDS&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;CLUBS&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="arrays">Arrays</h3>
<p>Arrays use the type name &ldquo;array&rdquo; and support a single attribute:</p>
<ul>
<li><em>items</em>: the schema of the array&rsquo;s items.</li>
</ul>
<p>For example, an array of strings is declared with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;array&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;items&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="maps">Maps</h3>
<p>Maps use the type name &ldquo;map&rdquo; and support one attribute:</p>
<ul>
<li><em>values</em>: the schema of the map&rsquo;s values.</li>
</ul>
<p>Map keys are assumed to be strings.</p>
<p>For example, a map from string to long is declared with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;values&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;long&#34;</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="unions">Unions</h3>
<p>Unions, as mentioned above, are represented using JSON arrays. For example, <code>[&quot;string&quot;, &quot;null&quot;]</code> declares a schema which may be either a string or null.</p>
<p>Unions may not contain more than one schema with the same type, except for the named types record, fixed and enum. For example, unions containing two array types or two map types are not permitted, but two types with different names are permitted. (Names permit efficient resolution when reading and writing unions.)</p>
<p>Unions may not immediately contain other unions.</p>
<h3 id="fixed">Fixed</h3>
<p>Fixed uses the type name &ldquo;fixed&rdquo; and supports two attributes:</p>
<ul>
<li><em>name</em>: a string naming this fixed (required).</li>
<li><em>namespace</em>, a string that qualifies the name;</li>
<li><em>aliases</em>: a JSON array of strings, providing alternate names for this enum (optional).</li>
<li><em>size</em>: an integer, specifying the number of bytes per value (required).</li>
</ul>
<p>For example, 16-byte quantity may be declared with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;md5&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="names">Names</h3>
<p>Record, enums and fixed are named types. Each has a fullname that is composed of two parts; a name and a namespace. Equality of names is defined on the fullname.</p>
<p>The name portion of a fullname, record field names, and enum symbols must:</p>
<ul>
<li>start with [A-Za-z_]</li>
<li>subsequently contain only [A-Za-z0-9_]</li>
</ul>
<p>A namespace is a dot-separated sequence of such names. Equality of names (including field names and enum symbols) as well as fullnames is case-sensitive.</p>
<p>In record, enum and fixed definitions, the fullname is determined in one of the following ways:</p>
<p>A name and namespace are both specified. For example, one might use &ldquo;name&rdquo;: &ldquo;X&rdquo;, &ldquo;namespace&rdquo;: &ldquo;org.foo&rdquo; to indicate the fullname org.foo.X.</p>
<ul>
<li>
<p>A fullname is specified. If the name specified contains a dot, then it is assumed to be a fullname, and any namespace also specified is ignored. For example, use &ldquo;name&rdquo;: &ldquo;org.foo.X&rdquo; to indicate the fullname org.foo.X.</p>
</li>
<li>
<p>A name only is specified, i.e., a name that contains no dots. In this case the namespace is taken from the most tightly enclosing schema or protocol. For example, if &ldquo;name&rdquo;: &ldquo;X&rdquo; is specified, and this occurs within a field of the record definition of org.foo.Y, then the fullname is org.foo.X.</p>
</li>
</ul>
<p>References to previously defined names are as in the latter two cases above: if they contain a dot they are a fullname, if they do not contain a dot, the namespace is the namespace of the enclosing definition.</p>
<p>Primitive type names have no namespace and their names may not be defined in any namespace.</p>
<p>A schema or protocol may not contain multiple definitions of a fullname. Further, a name must be defined before it is used (&ldquo;before&rdquo; in the depth-first, left-to-right traversal of the JSON parse tree, where the types attribute of a protocol is always deemed to come &ldquo;before&rdquo; the messages attribute.)</p>
<h3 id="aliases">Aliases</h3>
<p>Named types and fields may have aliases. An implementation may optionally use aliases to map a writer&rsquo;s schema to the reader&rsquo;s. This facilitates both schema evolution as well as processing disparate datasets.</p>
<p>Aliases function by re-writing the writer&rsquo;s schema using aliases from the reader&rsquo;s schema. For example, if the writer&rsquo;s schema was named &ldquo;Foo&rdquo; and the reader&rsquo;s schema is named &ldquo;Bar&rdquo; and has an alias of &ldquo;Foo&rdquo;, then the implementation would act as though &ldquo;Foo&rdquo; were named &ldquo;Bar&rdquo; when reading. Similarly, if data was written as a record with a field named &ldquo;x&rdquo; and is read as a record with a field named &ldquo;y&rdquo; with alias &ldquo;x&rdquo;, then the implementation would act as though &ldquo;x&rdquo; were named &ldquo;y&rdquo; when reading.</p>
<p>A type alias may be specified either as a fully namespace-qualified, or relative to the namespace of the name it is an alias for. For example, if a type named &ldquo;a.b&rdquo; has aliases of &ldquo;c&rdquo; and &ldquo;x.y&rdquo;, then the fully qualified names of its aliases are &ldquo;a.c&rdquo; and &ldquo;x.y&rdquo;.</p>
<h2 id="data-serialization">Data Serialization</h2>
<p>Avro data is always serialized with its schema. Files that store Avro data should always also include the schema for that data in the same file. Avro-based remote procedure call (RPC) systems must also guarantee that remote recipients of data have a copy of the schema used to write that data.</p>
<p>Because the schema used to write data is always available when the data is read, Avro data itself is not tagged with type information. The schema is required to parse data.</p>
<p>In general, both serialization and deserialization proceed as a depth-first, left-to-right traversal of the schema, serializing primitive types as they are encountered.</p>
<h3 id="encodings">Encodings</h3>
<p>Avro specifies two serialization encodings: binary and JSON. Most applications will use the binary encoding, as it is smaller and faster. But, for debugging and web-based applications, the JSON encoding may sometimes be appropriate.</p>
<h3 id="binary-encoding">Binary Encoding</h3>
<h4 id="primitive-types-1">Primitive Types</h4>
<p>Primitive types are encoded in binary as follows:</p>
<ul>
<li><em>null</em> is written as zero bytes.</li>
<li>a <em>boolean</em> is written as a single byte whose value is either 0 (false) or 1 (true).</li>
<li><em>int</em> and <em>long</em> values are written using <a href="https://lucene.apache.org/java/3_5_0/fileformats.html#VInt">variable-length</a> <a href="https://code.google.com/apis/protocolbuffers/docs/encoding.html#types">zig-zag</a> coding. Some examples:</li>
</ul>
<table>
<thead>
<tr>
<th><em>value</em></th>
<th><em>hex</em></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>00</td>
</tr>
<tr>
<td>-1</td>
<td>01</td>
</tr>
<tr>
<td>1</td>
<td>02</td>
</tr>
<tr>
<td>-2</td>
<td>03</td>
</tr>
<tr>
<td>2</td>
<td>04</td>
</tr>
<tr>
<td>&hellip;</td>
<td></td>
</tr>
<tr>
<td>-64</td>
<td>7f</td>
</tr>
<tr>
<td>64</td>
<td>80 01</td>
</tr>
<tr>
<td>&hellip;</td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>a <em>float</em> is written as 4 bytes. The float is converted into a 32-bit integer using a method equivalent to Java&rsquo;s <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Float.html#floatToIntBits-float-">floatToIntBits</a> and then encoded in little-endian format.</li>
<li>a <em>double</em> is written as 8 bytes. The double is converted into a 64-bit integer using a method equivalent to Java&rsquo;s <a href="https://docs.oracle.com/javase/8/docs/api/java/lang/Double.html#doubleToLongBits-double-">doubleToLongBits</a> and then encoded in little-endian format.</li>
<li><em>bytes</em> are encoded as a long followed by that many bytes of data.</li>
<li>a string is encoded as a long followed by that many bytes of UTF-8 encoded character data.</li>
</ul>
<p>For example, the three-character string &ldquo;foo&rdquo; would be encoded as the long value 3 (encoded as hex 06) followed by the UTF-8 encoding of &lsquo;f&rsquo;, &lsquo;o&rsquo;, and &lsquo;o&rsquo; (the hex bytes 66 6f 6f):</p>
<pre tabindex="0"><code>06 66 6f 6f
</code></pre><h3 id="complex-types-1">Complex Types</h3>
<p>Complex types are encoded in binary as follows:</p>
<h4 id="records">Records</h4>
<p>A record is encoded by encoding the values of its fields in the order that they are declared. In other words, a record is encoded as just the concatenation of the encodings of its fields. Field values are encoded per their schema.</p>
<p>For example, the record schema</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;test&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;a&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;long&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;b&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>An instance of this record whose a field has value 27 (encoded as hex 36) and whose b field has value &ldquo;foo&rdquo; (encoded as hex bytes 06 66 6f 6f), would be encoded simply as the concatenation of these, namely the hex byte sequence:</p>
<pre tabindex="0"><code>36 06 66 6f 6f
</code></pre><h4 id="enums-1">Enums</h4>
<p>An enum is encoded by a int, representing the zero-based position of the symbol in the schema.</p>
<p>For example, consider the enum:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Foo&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;symbols&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;A&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;B&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;C&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;D&#34;</span><span style="color:#000;font-weight:bold">]</span> <span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This would be encoded by an int between zero and three, with zero indicating &ldquo;A&rdquo;, and 3 indicating &ldquo;D&rdquo;.</p>
<h4 id="arrays-1">Arrays</h4>
<p>Arrays are encoded as a series of blocks. Each block consists of a long count value, followed by that many array items. A block with count zero indicates the end of the array. Each item is encoded per the array&rsquo;s item schema.</p>
<p>If a block&rsquo;s count is negative, its absolute value is used, and the count is followed immediately by a long block size indicating the number of bytes in the block. This block size permits fast skipping through data, e.g., when projecting a record to a subset of its fields.</p>
<p>For example, the array schema</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;array&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;items&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;long&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>an array containing the items 3 and 27 could be encoded as the long value 2 (encoded as hex 04) followed by long values 3 and 27 (encoded as hex 06 36) terminated by zero:</p>
<pre tabindex="0"><code>04 06 36 00
</code></pre><p>The blocked representation permits one to read and write arrays larger than can be buffered in memory, since one can start writing items without knowing the full length of the array.</p>
<h4 id="schema-maps">Maps</h4>
<p>Maps are encoded as a series of <em>blocks</em>. Each block consists of a <code>long</code> <em>count</em> value, followed by that many key/value pairs. A block with count zero indicates the end of the map. Each item is encoded per the map&rsquo;s value schema.</p>
<p>If a block&rsquo;s count is negative, its absolute value is used, and the count is followed immediately by a <code>long</code> block size indicating the number of bytes in the block. This block size permits fast skipping through data, e.g., when projecting a record to a subset of its fields.</p>
<p>The blocked representation permits one to read and write maps larger than can be buffered in memory, since one can start writing items without knowing the full length of the map.</p>
<h4 id="unions-1">Unions</h4>
<p>A union is encoded by first writing a <code>long</code> value indicating the zero-based position within the union of the schema of its value. The value is then encoded per the indicated schema within the union.</p>
<p>For example, the union schema <code>[&quot;string&quot;,&quot;null&quot;]</code> would encode:</p>
<ul>
<li>
<p>null as the integer 1 (the index of &ldquo;null&rdquo; in the union, encoded as hex 02):
02</p>
</li>
<li>
<p>the string &ldquo;a&rdquo; as zero (the index of &ldquo;string&rdquo; in the union), followed by the serialized string:
<code>02 02 61</code></p>
</li>
</ul>
<h4 id="fixed-1">Fixed</h4>
<p>Fixed instances are encoded using the number of bytes declared in the schema.</p>
<h3 id="json-encoding">JSON Encoding</h3>
<p>Except for unions, the JSON encoding is the same as is used to encode <a href="#schema-record">field default values</a>.</p>
<p>The value of a union is encoded in JSON as follows:</p>
<ul>
<li>if its type is <em>null</em>, then it is encoded as a JSON <em>null</em>;</li>
<li>otherwise it is encoded as a JSON object with one name/value pair whose name is the type&rsquo;s name and whose value is the recursively encoded value. For Avro&rsquo;s named types (record, fixed or enum) the user-specified name is used, for other types the type name is used.</li>
</ul>
<p>For example, the union schema <code>[&quot;null&quot;,&quot;string&quot;,&quot;Foo&quot;]</code>, where Foo is a record name, would encode:</p>
<ul>
<li><em>null</em> as <em>null</em>;</li>
<li>the string &ldquo;a&rdquo; as <code>{&quot;string&quot;: &quot;a&quot;}</code> and</li>
<li>a Foo instance as <code>{&quot;Foo&quot;: {...}}</code>, where <code>{...}</code> indicates the JSON encoding of a Foo instance.</li>
</ul>
<p>Note that a schema is still required to correctly process JSON-encoded data. For example, the JSON encoding does not distinguish between int and long, float and double, records and maps, enums and strings, etc.</p>
<h2 id="sort-order">Sort Order</h2>
<p>Avro defines a standard sort order for data. This permits data written by one system to be efficiently sorted by another system. This can be an important optimization, as sort order comparisons are sometimes the most frequent per-object operation. Note also that Avro binary-encoded data can be efficiently ordered without deserializing it to objects.</p>
<p>Data items may only be compared if they have identical schemas. Pairwise comparisons are implemented recursively with a depth-first, left-to-right traversal of the schema. The first mismatch encountered determines the order of the items.</p>
<p>Two items with the same schema are compared according to the following rules.</p>
<ul>
<li><em>null</em> data is always equal.</li>
<li><em>boolean</em> data is ordered with false before true.</li>
<li><em>int</em>, <em>long</em>, <em>float</em> and <em>double</em> data is ordered by ascending numeric value.</li>
<li><em>bytes</em> and fixed data are compared lexicographically by unsigned 8-bit values.</li>
<li><em>string</em> data is compared lexicographically by Unicode code point. Note that since UTF-8 is used as the binary encoding for strings, sorting of bytes and string binary data is identical.</li>
<li><em>array</em> data is compared lexicographically by element.</li>
<li><em>enum</em> data is ordered by the symbol&rsquo;s position in the enum schema. For example, an enum whose symbols are <code>[&quot;z&quot;, &quot;a&quot;]</code> would sort &ldquo;z&rdquo; values before &ldquo;a&rdquo; values.</li>
<li><em>union</em> data is first ordered by the branch within the union, and, within that, by the type of the branch. For example, an <code>[&quot;int&quot;, &quot;string&quot;]</code> union would order all int values before all string values, with the ints and strings themselves ordered as defined above.</li>
<li><em>record</em> data is ordered lexicographically by field. If a field specifies that its order is:
<ul>
<li>&ldquo;ascending&rdquo;, then the order of its values is unaltered.</li>
<li>&ldquo;descending&rdquo;, then the order of its values is reversed.</li>
<li>&ldquo;ignore&rdquo;, then its values are ignored when sorting.</li>
</ul>
</li>
<li><em>map</em> data may not be compared. It is an error to attempt to compare data containing maps unless those maps are in an <code>&quot;order&quot;:&quot;ignore&quot;</code> record field.</li>
</ul>
<h2 id="object-container-files">Object Container Files</h2>
<p>Avro includes a simple object container file format. A file has a schema, and all objects stored in the file must be written according to that schema, using binary encoding. Objects are stored in blocks that may be compressed. Syncronization markers are used between blocks to permit efficient splitting of files for MapReduce processing.</p>
<p>Files may include arbitrary user-specified metadata.</p>
<p>A file consists of:</p>
<ul>
<li>A file header, followed by</li>
<li>one or more file data blocks.</li>
</ul>
<p>A file header consists of:</p>
<ul>
<li>Four bytes, ASCII &lsquo;O&rsquo;, &lsquo;b&rsquo;, &lsquo;j&rsquo;, followed by 1.</li>
<li>file metadata, including the schema.</li>
<li>The 16-byte, randomly-generated sync marker for this file.</li>
</ul>
<p>File metadata is written as if defined by the following <a href="#schema-maps">map</a> schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;values&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>All metadata properties that start with &ldquo;avro.&rdquo; are reserved. The following file metadata properties are currently used:</p>
<ul>
<li><strong>avro.schema</strong> contains the schema of objects stored in the file, as JSON data (required).</li>
<li><strong>avro.codec</strong> the name of the compression codec used to compress blocks, as a string. Implementations are required to support the following codecs: &ldquo;null&rdquo; and &ldquo;deflate&rdquo;. If codec is absent, it is assumed to be &ldquo;null&rdquo;. The codecs are described with more detail below.</li>
</ul>
<p>A file header is thus described by the following schema:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;org.apache.avro.file.Header&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;magic&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Magic&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">4</span><span style="color:#000;font-weight:bold">}},</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;meta&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;values&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">}},</span>
</span></span><span style="display:flex;"><span>   <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;sync&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Sync&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">}}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>A file data block consists of:</p>
<ul>
<li>A long indicating the count of objects in this block.</li>
<li>A long indicating the size in bytes of the serialized objects in the current block, after any codec is applied</li>
<li>The serialized objects. If a codec is specified, this is compressed by that codec.</li>
<li>The file&rsquo;s 16-byte sync marker.</li>
</ul>
<p>Thus, each block&rsquo;s binary data can be efficiently extracted or skipped without deserializing the contents. The combination of block size, object counts, and sync markers enable detection of corrupt blocks and help ensure data integrity.</p>
<h3 id="required-codecs">Required Codecs</h3>
<p><em>null</em></p>
<p>The &ldquo;null&rdquo; codec simply passes through data uncompressed.</p>
<p><em>deflate</em></p>
<p>The &ldquo;deflate&rdquo; codec writes the data block using the deflate algorithm as specified in <a href="https://www.isi.edu/in-notes/rfc1951.txt">RFC 1951</a>, and typically implemented using the zlib library. Note that this format (unlike the &ldquo;zlib format&rdquo; in RFC 1950) does not have a checksum.</p>
<h3 id="optional-codecs">Optional Codecs</h3>
<p><em>snappy</em></p>
<p>The &ldquo;snappy&rdquo; codec uses Google&rsquo;s <a href="https://code.google.com/p/snappy/">Snappy</a> compression library. Each compressed block is followed by the 4-byte, big-endian CRC32 checksum of the uncompressed data in the block.</p>
<h3 id="protocol-declaration">Protocol Declaration</h3>
<p>Avro protocols describe RPC interfaces. Like schemas, they are defined with JSON text.</p>
<p>A protocol is a JSON object with the following attributes:</p>
<ul>
<li><em>protocol</em>, a string, the name of the protocol (required);</li>
<li><em>namespace</em>, an optional string that qualifies the name;</li>
<li><em>doc</em>, an optional string describing this protocol;</li>
<li><em>types</em>, an optional list of definitions of named types (records, enums, fixed and errors). An error definition is just like a record definition except it uses &ldquo;error&rdquo; instead of &ldquo;record&rdquo;. Note that forward references to named types are not permitted.</li>
<li><em>messages</em>, an optional JSON object whose keys are message names and whose values are objects whose attributes are described below. No two messages may have the same name.</li>
</ul>
<p>The name and namespace qualification rules defined for schema objects apply to protocols as well.</p>
<h3 id="messages">Messages</h3>
<p>A message has attributes:</p>
<ul>
<li>a <em>doc</em>, an optional description of the message,</li>
<li>a <em>request</em>, a list of named, typed parameter schemas (this has the same form as the fields of a record declaration);</li>
<li>a <em>response</em> schema;</li>
<li>an optional union of declared error schemas. The effective union has &ldquo;string&rdquo; prepended to the declared union, to permit transmission of undeclared &ldquo;system&rdquo; errors. For example, if the declared error union is <code>[&quot;AccessError&quot;]</code>, then the effective union is <code>[&quot;string&quot;, &quot;AccessError&quot;]</code>. When no errors are declared, the effective error union is <code>[&quot;string&quot;]</code>. Errors are serialized using the effective union; however, a protocol&rsquo;s JSON declaration contains only the declared union.</li>
<li>an optional one-way boolean parameter.</li>
</ul>
<p>A request parameter list is processed equivalently to an anonymous record. Since record field lists may vary between reader and writer, request parameters may also differ between the caller and responder, and such differences are resolved in the same manner as record field differences.</p>
<p>The one-way parameter may only be true when the response type is <code>&quot;null&quot;</code> and no errors are listed.</p>
<h3 id="sample-protocol">Sample Protocol</h3>
<p>For example, one may define a simple HelloWorld protocol with:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;com.acme&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;HelloWorld&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;doc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Protocol Greetings&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;types&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Greeting&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">}]},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Curse&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;error&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;message&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">}]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;messages&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&#34;hello&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;doc&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Say hello.&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;request&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;greeting&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Greeting&#34;</span> <span style="color:#000;font-weight:bold">}],</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;response&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;Greeting&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&#34;errors&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;Curse&#34;</span><span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><h2 id="protocol-wire-format">Protocol Wire Format</h2>
<h3 id="message-transport">Message Transport</h3>
<p>Messages may be transmitted via different transport mechanisms.</p>
<p>To the transport, a <em>message</em> is an opaque byte sequence.</p>
<p>A transport is a system that supports:</p>
<ul>
<li><strong>transmission of request messages</strong></li>
<li><strong>receipt of corresponding response messages</strong></li>
</ul>
<p>Servers may send a response message back to the client corresponding to a request message. The mechanism of correspondance is transport-specific. For example, in HTTP it is implicit, since HTTP directly supports requests and responses. But a transport that multiplexes many client threads over a single socket would need to tag messages with unique identifiers.</p>
<p>Transports may be either stateless or stateful. In a stateless transport, messaging assumes no established connection state, while stateful transports establish connections that may be used for multiple messages. This distinction is discussed further in the <a href="#handshake">handshake</a> section below.</p>
<h4 id="http-as-transport">HTTP as Transport</h4>
<p>When <a href="https://www.w3.org/Protocols/rfc2616/rfc2616.html">HTTP</a> is used as a transport, each Avro message exchange is an HTTP request/response pair. All messages of an Avro protocol should share a single URL at an HTTP server. Other protocols may also use that URL. Both normal and error Avro response messages should use the 200 (OK) response code. The chunked encoding may be used for requests and responses, but, regardless the Avro request and response are the entire content of an HTTP request and response. The HTTP Content-Type of requests and responses should be specified as &ldquo;avro/binary&rdquo;. Requests should be made using the POST method.</p>
<p>HTTP is used by Avro as a stateless transport.</p>
<h3 id="message-framing">Message Framing</h3>
<p>Avro messages are <em>framed</em> as a list of buffers.</p>
<p>Framing is a layer between messages and the transport. It exists to optimize certain operations.</p>
<p>The format of framed message data is:</p>
<ul>
<li>a series of buffers, where each buffer consists of:
<ul>
<li>a four-byte, big-endian <em>buffer length</em>, followed by</li>
<li>that many bytes of <em>buffer</em> data.</li>
</ul>
</li>
<li>A message is always terminated by a zero-lenghted buffer.</li>
</ul>
<p>Framing is transparent to request and response message formats (described below). Any message may be presented as a single or multiple buffers.</p>
<p>Framing can permit readers to more efficiently get different buffers from different sources and for writers to more efficiently store different buffers to different destinations. In particular, it can reduce the number of times large binary objects are copied. For example, if an RPC parameter consists of a megabyte of file data, that data can be copied directly to a socket from a file descriptor, and, on the other end, it could be written directly to a file descriptor, never entering user space.</p>
<p>A simple, recommended, framing policy is for writers to create a new segment whenever a single binary object is written that is larger than a normal output buffer. Small objects are then appended in buffers, while larger objects are written as their own buffers. When a reader then tries to read a large object the runtime can hand it an entire buffer directly, without having to copy it.</p>
<h3 id="handshake">Handshake</h3>
<p>The purpose of the handshake is to ensure that the client and the server have each other&rsquo;s protocol definition, so that the client can correctly deserialize responses, and the server can correctly deserialize requests. Both clients and servers should maintain a cache of recently seen protocols, so that, in most cases, a handshake will be completed without extra round-trip network exchanges or the transmission of full protocol text.</p>
<p>RPC requests and responses may not be processed until a handshake has been completed. With a stateless transport, all requests and responses are prefixed by handshakes. With a stateful transport, handshakes are only attached to requests and responses until a successful handshake response has been returned over a connection. After this, request and response payloads are sent without handshakes for the lifetime of that connection.</p>
<p>The handshake process uses the following record schemas:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;HandshakeRequest&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span><span style="color:#4e9a06">&#34;org.apache.avro.ipc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;clientHash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MD5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">}},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;clientProtocol&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">]},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;serverHash&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MD5&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;meta&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;values&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">}]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;HandshakeResponse&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;org.apache.avro.ipc&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;match&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;enum&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;HandshakeMatch&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;symbols&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;BOTH&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;CLIENT&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;NONE&#34;</span><span style="color:#000;font-weight:bold">]}},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;serverProtocol&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">]},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;serverHash&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;fixed&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MD5&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;size&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#0000cf;font-weight:bold">16</span><span style="color:#000;font-weight:bold">}]},</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;meta&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>     <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;map&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;values&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;bytes&#34;</span><span style="color:#000;font-weight:bold">}]}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><ul>
<li>A client first prefixes each request with a <code>HandshakeRequest</code> containing just the hash of its protocol and of the server&rsquo;s protocol (<code>clientHash!=null, clientProtocol=null, serverHash!=null</code>), where the hashes are 128-bit MD5 hashes of the JSON protocol text. If a client has never connected to a given server, it sends its hash as a guess of the server&rsquo;s hash, otherwise it sends the hash that it previously obtained from this server.</li>
</ul>
<p>The server responds with a HandshakeResponse containing one of:</p>
<ul>
<li>
<p><code>match=BOTH, serverProtocol=null, serverHash=null</code> if the client sent the valid hash of the server&rsquo;s protocol and the server knows what protocol corresponds to the client&rsquo;s hash. In this case, the request is complete and the response data immediately follows the HandshakeResponse.</p>
</li>
<li>
<p><code>match=CLIENT, serverProtocol!=null, serverHash!=null</code> if the server has previously seen the client&rsquo;s protocol, but the client sent an incorrect hash of the server&rsquo;s protocol. The request is complete and the response data immediately follows the HandshakeResponse. The client must use the returned protocol to process the response and should also cache that protocol and its hash for future interactions with this server.</p>
</li>
<li>
<p><code>match=NONE</code> if the server has not previously seen the client&rsquo;s protocol. The serverHash and serverProtocol may also be non-null if the server&rsquo;s protocol hash was incorrect.</p>
</li>
</ul>
<p>In this case the client must then re-submit its request with its protocol text (<code>clientHash!=null, clientProtocol!=null, serverHash!=null</code>) and the server should respond with a successful match (match=BOTH, serverProtocol=null, serverHash=null) as above.</p>
<p>The meta field is reserved for future handshake enhancements.</p>
<h3 id="call-format">Call Format</h3>
<p>A <em>call</em> consists of a request message paired with its resulting response or error message. Requests and responses contain extensible metadata, and both kinds of messages are framed as described above.</p>
<p>The format of a call request is:</p>
<ul>
<li><em>request metadata</em>, a map with values of type bytes</li>
<li>the <em>message name</em>, an Avro string, followed by</li>
<li>the <em>message parameters</em>. Parameters are serialized according to the message&rsquo;s request declaration.</li>
</ul>
<p>When the empty string is used as a message name a server should ignore the parameters and return an empty response. A client may use this to ping a server or to perform a handshake without sending a protocol message.</p>
<p>When a message is declared one-way and a stateful connection has been established by a successful handshake response, no response data is sent. Otherwise the format of the call response is:</p>
<ul>
<li><em>response metadata</em>, a map with values of type bytes</li>
<li>a one-byte error <em>flag</em> boolean, followed by either:
<ul>
<li>if the error flag is false, the message <em>response</em>, serialized per the message&rsquo;s response schema.</li>
<li>if the error flag is true, the <em>error</em>, serialized per the message&rsquo;s effective error union schema.</li>
</ul>
</li>
</ul>
<h3 id="schema-resolution">Schema Resolution</h3>
<p>A reader of Avro data, whether from an RPC or a file, can always parse that data because its schema is provided. But that schema may not be exactly the schema that was expected. For example, if the data was written with a different version of the software than it is read, then records may have had fields added or removed. This section specifies how such schema differences should be resolved.</p>
<p>We refer to the schema used to write the data as the writer&rsquo;s schema, and the schema that the application expects the reader&rsquo;s schema. Differences between these should be resolved as follows:</p>
<ul>
<li>It is an error if the two schemas do not <em>match</em>.</li>
</ul>
<p>To match, one of the following must hold:</p>
<ul>
<li>
<p>both schemas are arrays whose item types match</p>
</li>
<li>
<p>both schemas are maps whose value types match</p>
</li>
<li>
<p>both schemas are enums whose names match</p>
</li>
<li>
<p>both schemas are fixed whose sizes and names match</p>
</li>
<li>
<p>both schemas are records with the same name</p>
</li>
<li>
<p>either schema is a union</p>
</li>
<li>
<p>both schemas have same primitive type</p>
</li>
<li>
<p>the writer&rsquo;s schema may be promoted to the reader&rsquo;s as follows:</p>
<ul>
<li>int is promotable to long, float, or double</li>
<li>long is promotable to float or double</li>
<li>float is promotable to double</li>
<li>string is promotable to bytes</li>
<li>bytes is promotable to string</li>
</ul>
</li>
<li>
<p><strong>if both are records</strong>:</p>
<ul>
<li>the ordering of fields may be different: fields are matched by name.</li>
<li>schemas for fields with the same name in both records are resolved recursively.</li>
<li>if the writer&rsquo;s record contains a field with a name not present in the reader&rsquo;s record, the writer&rsquo;s value for that field is ignored.</li>
<li>if the reader&rsquo;s record schema has a field that contains a default value, and writer&rsquo;s schema does not have a field with the same name, then the reader should use the default value from its field.</li>
<li>if the reader&rsquo;s record schema has a field with no default value, and writer&rsquo;s schema does not have a field with the same name, an error is signalled.</li>
</ul>
</li>
<li>
<p><strong>if both are enums</strong>:</p>
</li>
</ul>
<p>if the writer&rsquo;s symbol is not present in the reader&rsquo;s enum and the reader has a default value, then that value is used, otherwise an error is signalled.</p>
<ul>
<li><strong>if both are arrays</strong>:</li>
</ul>
<p>This resolution algorithm is applied recursively to the reader&rsquo;s and writer&rsquo;s array item schemas.</p>
<ul>
<li><strong>if both are maps</strong>:</li>
</ul>
<p>This resolution algorithm is applied recursively to the reader&rsquo;s and writer&rsquo;s value schemas.</p>
<ul>
<li><strong>if both are unions</strong>:</li>
</ul>
<p>The first schema in the reader&rsquo;s union that matches the selected writer&rsquo;s union schema is recursively resolved against it. if none match, an error is signalled.</p>
<ul>
<li><strong>if reader&rsquo;s is a union, but writer&rsquo;s is not</strong></li>
</ul>
<p>The first schema in the reader&rsquo;s union that matches the writer&rsquo;s schema is recursively resolved against it. If none match, an error is signalled.</p>
<ul>
<li><strong>if writer&rsquo;s is a union, but reader&rsquo;s is not</strong></li>
</ul>
<p>If the reader&rsquo;s schema matches the selected writer&rsquo;s schema, it is recursively resolved against it. If they do not match, an error is signalled.</p>
<p>A schema&rsquo;s <em>doc</em> fields are ignored for the purposes of schema resolution. Hence, the <em>doc</em> portion of a schema may be dropped at serialization.</p>
<h3 id="parsing-canonical-form-for-schemas">Parsing Canonical Form for Schemas</h3>
<p>One of the defining characteristics of Avro is that a reader is assumed to have the &ldquo;same&rdquo; schema used by the writer of the data the reader is reading. This assumption leads to a data format that&rsquo;s compact and also amenable to many forms of schema evolution. However, the specification so far has not defined what it means for the reader to have the &ldquo;same&rdquo; schema as the writer. Does the schema need to be textually identical? Well, clearly adding or removing some whitespace to a JSON expression does not change its meaning. At the same time, reordering the fields of records clearly does change the meaning. So what does it mean for a reader to have &ldquo;the same&rdquo; schema as a writer?</p>
<p>Parsing Canonical Form is a transformation of a writer&rsquo;s schema that let&rsquo;s us define what it means for two schemas to be &ldquo;the same&rdquo; for the purpose of reading data written against the schema. It is called Parsing Canonical Form because the transformations strip away parts of the schema, like &ldquo;doc&rdquo; attributes, that are irrelevant to readers trying to parse incoming data. It is called Canonical Form because the transformations normalize the JSON text (such as the order of attributes) in a way that eliminates unimportant differences between schemas. If the Parsing Canonical Forms of two different schemas are textually equal, then those schemas are &ldquo;the same&rdquo; as far as any reader is concerned, i.e., there is no serialized data that would allow a reader to distinguish data generated by a writer using one of the original schemas from data generated by a writing using the other original schema. (We sketch a proof of this property in a companion document.)</p>
<p>The next subsection specifies the transformations that define Parsing Canonical Form. But with a well-defined canonical form, it can be convenient to go one step further, transforming these canonical forms into simple integers (&ldquo;fingerprints&rdquo;) that can be used to uniquely identify schemas. The subsection after next recommends some standard practices for generating such fingerprints.</p>
<h4 id="transforming-into-parsing-canonical-form">Transforming into Parsing Canonical Form</h4>
<p>Assuming an input schema (in JSON form) that&rsquo;s already UTF-8 text for a <em>valid</em> Avro schema (including all quotes as required by JSON), the following transformations will produce its Parsing Canonical Form:</p>
<ul>
<li>[PRIMITIVES] Convert primitive schemas to their simple form (e.g., int instead of <code>{&quot;type&quot;:&quot;int&quot;}</code>).</li>
<li>[FULLNAMES] Replace short names with fullnames, using applicable namespaces to do so. Then eliminate namespace attributes, which are now redundant.</li>
<li>[STRIP] Keep only attributes that are relevant to parsing data, which are: <em>type</em>, <em>name</em>, <em>fields</em>, <em>symbols</em>, <em>items</em>, <em>values</em>, <em>size</em>. Strip all others (e.g., <em>doc</em> and <em>aliases</em>).</li>
<li>[ORDER] Order the appearance of fields of JSON objects as follows: <em>name</em>, <em>type</em>, <em>fields</em>, <em>symbols</em>, <em>items</em>, <em>values</em>, <em>size</em>. For example, if an object has <em>type</em>, <em>name</em>, and <em>size</em> fields, then the <em>name</em> field should appear first, followed by the <em>type</em> and then the <em>size</em> fields.</li>
<li>[STRINGS] For all JSON string literals in the schema text, replace any escaped characters (e.g., \uXXXX escapes) with their UTF-8 equivalents.</li>
<li>[INTEGERS] Eliminate quotes around and any leading zeros in front of JSON integer literals (which appear in the <em>size</em> attributes of <em>fixed</em> schemas).</li>
<li>[WHITESPACE] Eliminate all whitespace in JSON outside of string literals.</li>
</ul>
<h4 id="schema-fingerprints">Schema Fingerprints</h4>
<p>&ldquo;[A] fingerprinting algorithm is a procedure that maps an arbitrarily large data item (such as a computer file) to a much shorter bit string, its fingerprint, that uniquely identifies the original data for all practical purposes&rdquo; (quoted from <a href="https://en.wikipedia.org/wiki/Fingerprint_(computing)">Wikipedia</a>). In the Avro context, fingerprints of Parsing Canonical Form can be useful in a number of applications; for example, to cache encoder and decoder objects, to tag data items with a short substitute for the writer&rsquo;s full schema, and to quickly negotiate common-case schemas between readers and writers.</p>
<p>In designing fingerprinting algorithms, there is a fundamental trade-off between the length of the fingerprint and the probability of collisions. To help application designers find appropriate points within this trade-off space, while encouraging interoperability and ease of implementation, we recommend using one of the following three algorithms when fingerprinting Avro schemas:</p>
<ul>
<li>When applications can tolerate longer fingerprints, we recommend using the <a href="https://en.wikipedia.org/wiki/SHA-2">SHA-256 digest algorithm</a> to generate 256-bit fingerprints of Parsing Canonical Forms. Most languages today have SHA-256 implementations in their libraries.</li>
<li>At the opposite extreme, the smallest fingerprint we recommend is a 64-bit <a href="https://en.wikipedia.org/wiki/Rabin_fingerprint">Rabin fingerprint</a>. Below, we provide pseudo-code for this algorithm that can be easily translated into any programming language. 64-bit fingerprints should guarantee uniqueness for schema caches of up to a million entries (for such a cache, the chance of a collision is 3E-8). We don&rsquo;t recommend shorter fingerprints, as the chances of collisions is too great (for example, with 32-bit fingerprints, a cache with as few as 100,000 schemas has a 50% chance of having a collision).</li>
<li>Between these two extremes, we recommend using the <a href="https://en.wikipedia.org/wiki/MD5">MD5 message digest</a> to generate 128-bit fingerprints. These make sense only where very large numbers of schemas are being manipulated (tens of millions); otherwise, 64-bit fingerprints should be sufficient. As with SHA-256, MD5 implementations are found in most libraries today.</li>
</ul>
<p>These fingerprints are not meant to provide any security guarantees, even the longer SHA-256-based ones. Most Avro applications should be surrounded by security measures that prevent attackers from writing random data and otherwise interfering with the consumers of schemas. We recommend that these surrounding mechanisms be used to prevent collision and pre-image attacks (i.e., &ldquo;forgery&rdquo;) on schema fingerprints, rather than relying on the security properties of the fingerprints themselves.</p>
<p>Rabin fingerprints are <a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check">cyclic redundancy checks</a> computed using irreducible polynomials. In the style of the Appendix of <a href="https://www.ietf.org/rfc/rfc1952.txt">RFC 1952</a> (pg 10), which defines the CRC-32 algorithm, here&rsquo;s our definition of the 64-bit AVRO fingerprinting algorithm:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fingerprint64</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">byte</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">buf</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">FP_TABLE</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">initFPTable</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">EMPTY</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#000">buf</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++)</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">FP_TABLE</span><span style="color:#ce5c00;font-weight:bold">[(</span><span style="color:#204a87;font-weight:bold">int</span><span style="color:#ce5c00;font-weight:bold">)(</span><span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#000">buf</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">])</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">0xff</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#000">fp</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">EMPTY</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0xc15d213aa4d7a795L</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">FP_TABLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">initFPTable</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">FP_TABLE</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#204a87;font-weight:bold">long</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">];</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">i</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">256</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">++)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span> <span style="color:#ce5c00;font-weight:bold">&lt;</span> <span style="color:#0000cf;font-weight:bold">8</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#000">j</span><span style="color:#ce5c00;font-weight:bold">++)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">&gt;&gt;&gt;</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">^</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">EMPTY</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#ce5c00;font-weight:bold">-(</span><span style="color:#000">fp</span> <span style="color:#ce5c00;font-weight:bold">&amp;</span> <span style="color:#0000cf;font-weight:bold">1L</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FP_TABLE</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#000">i</span><span style="color:#ce5c00;font-weight:bold">]</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">fp</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Readers interested in the mathematics behind this algorithm may want to read this book chapter. (Unlike RFC-1952 and the book chapter, we prepend a single one bit to messages. We do this because CRCs ignore leading zero bits, which can be problematic. Our code prepends a one-bit by initializing fingerprints using EMPTY, rather than initializing using zero as in RFC-1952 and the book chapter.)</p>
<p>Apache Avro, Avro, Apache, and the Avro and Apache logos are trademarks of The Apache Software Foundation.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-587b98bca97043e057c22ee05fcc9146">4 - Trevni</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="trevni-a-column-file-format">Trevni: A Column File Format</h2>
<p>Version 0.1</p>
<p>DRAFT</p>
<p>This document is the authoritative specification of a file format. Its intent is to permit compatible, independent implementations that read and/or write files in this format.</p>
<h2 id="introduction">Introduction</h2>
<p>Data sets are often described as a table composed of rows and columns. Each record in the dataset is considered a row, with each field of the record occupying a different column. Writing records to a file one-by-one as they are created results in a row-major format, like Hadoop’s SequenceFile or Avro data files.</p>
<p>In many cases higher query performance may be achieved if the data is instead organized in a column-major format, where multiple values of a given column are stored adjacently. This document defines such a column-major file format for datasets.</p>
<p>To permit scalable, distributed query evaluation, datasets are partitioned into row groups, containing distinct collections of rows. Each row group is organized in column-major order, while row groups form a row-major partitioning of the entire dataset.</p>
<h2 id="rationale">Rationale</h2>
<h3 id="goals">Goals</h3>
<p>The format is meant satisfy the following goals:</p>
<p>Maximize the size of row groups. Disc drives are used most efficiently when sequentially accessing data. Consider a drive that takes 10ms to seek and transfers at 100MB/second. If a 10-column dataset whose values are all the same size is split into 10MB row groups, then accessing a single column will require a sequence of seek+1MB reads, for a cost of 20ms/MB processed. If the same dataset is split into 100MB row groups then this drops to 11ms/MB processed. This effect is exaggerated for datasets with larger numbers of columns and with columns whose values are smaller than average. So we’d prefer row groups that are 100MB or greater.</p>
<p>Permit random access within a row group. Some queries will first examine one column, and, only when certain relatively rare criteria are met, examine other columns. Rather than iterating through selected columns of the row-group in parallel, one might iterate through one column and randomly access another. This is called support for WHERE clauses, after the SQL operator of that name.</p>
<p>Minimize the number of files per dataset. HDFS is a primary intended deployment platform for these files. The HDFS Namenode requires memory for each file in the filesystem, thus for a format to be HDFS-friendly it should strive to require the minimum number of distinct files.</p>
<p>Support co-location of columns within row-groups. Row groups are the unit of parallel operation on a column dataset. For efficient file i/o, the entirety of a row-group should ideally reside on the host that is evaluating the query in order to avoid network latencies and bottlenecks.</p>
<p>Data integrity. The format should permit applications to detect data corruption. Many file systems may prevent corruption, but files may be moved between filesystems and be subject to corruption at points in that process. It is best if the data in a file can be validated independently.</p>
<p>Extensibility. The format should permit applications to store additional annotations about a datasets in the files, such as type information, origin, etc. Some environments may have metadata stores for such information, but not all do, and files might be moved among systems with different metadata systems. The ability to keep such information within the file simplifies the coordination of such information.</p>
<p>Minimal overhead. The column format should not make datasets appreciably larger. Storage is a primary cost and a choice to use this format should not require additional storage.</p>
<p>Primary format. The column format should be usable as a primary format for datasets, not as an auxiliary, accelerated format. Applications that process a dataset in row-major order should be able to easily consume column files and applications that produce datasets in row-major order should be able to easily generate column files.</p>
<h3 id="design">Design</h3>
<p>To meet these goals we propose the following design.</p>
<p>Each row group is a separate file. All values of a column in a file are written contiguously. This maximizes the row group size, optimizing performance when querying few and small columns.</p>
<p>Each file occupies a single HDFS block. A larger than normal block size may be specified, e.g., ~1GB instead of the typical ~100MB. This guarantees co-location and eliminates network use when query processing can be co-located with the file. This also moderates the memory impact on the HDFS Namenode since no small files are written.
Each column in a file is written as a sequence of ~64kB compressed blocks. The sequence is prefixed by a table describing all of the blocks in the column to permit random access within the column.</p>
<p>Application-specific metadata may be added at the file, column, and block levels.
Checksums are included with each block, providing data integrity.</p>
<h3 id="discussion">Discussion</h3>
<p>The use of a single block per file achieves the same effect as the custom block placement policy described in the CIF paper, but while still permitting HDFS rebalancing and not increasing the number of files in the namespace.</p>
<h2 id="format-specification">Format Specification</h2>
<p>This section formally describes the proposed column file format.</p>
<h3 id="data-model">Data Model</h3>
<p>We assume a simple data model, where a record is a set of named fields, and the value of each field is a sequence of untyped bytes. A type system may be layered on top of this, as specified in the Type Mapping section below.</p>
<h3 id="primitive-values">Primitive Values</h3>
<p>We define the following primitive value types:</p>
<ul>
<li>Signed 64-bit long values are written using a variable-length zig-zag coding, where the high-order bit in each byte determines whether subsequent bytes are present. For example:
decimal value	hex bytes</li>
</ul>
<table>
<thead>
<tr>
<th>decimal value</th>
<th>hex bytes</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>0</td>
<td>00</td>
<td></td>
</tr>
<tr>
<td>-1</td>
<td>01</td>
<td></td>
</tr>
<tr>
<td>1</td>
<td>02</td>
<td></td>
</tr>
<tr>
<td>&hellip;</td>
<td></td>
<td></td>
</tr>
<tr>
<td>-64</td>
<td>7f</td>
<td></td>
</tr>
<tr>
<td>64</td>
<td>80 01</td>
<td></td>
</tr>
<tr>
<td>&hellip;</td>
<td></td>
<td></td>
</tr>
</tbody>
</table>
<ul>
<li>bytes are encoded as a long followed by that many bytes of data.</li>
<li>a string is encoded as a long followed by that many bytes of UTF-8 encoded character data.</li>
</ul>
<p>For example, the three-character string &ldquo;foo&rdquo; would be encoded as the long value 3 (encoded as hex 06) followed by the UTF-8 encoding of &lsquo;f&rsquo;, &lsquo;o&rsquo;, and &lsquo;o&rsquo; (the hex bytes 66 6f 6f): 06 66 6f 6f</p>
<h2 id="type-names">Type Names</h2>
<p>The following type names are used to describe column values:</p>
<ul>
<li>null, requires zero bytes. Sometimes used in array columns.</li>
<li>boolean, one bit, packed into bytes, little-endian;</li>
<li>int, like long, but restricted to 32-bit signed values</li>
<li>long 64-bit signed values, represented as above</li>
<li>fixed32 32-bit values stored as four bytes, little-endian.</li>
<li>fixed64 64-bit values stored as eight bytes, little-endian.</li>
<li>float 32-bit IEEE floating point value, little-endian</li>
<li>double 64-bit IEEE floating point value, little-endian</li>
<li>string as above</li>
<li>bytes as above, may be used to encapsulate more complex objects</li>
</ul>
<p>Type names are represented as strings (UTF-8 encoded, length-prefixed).</p>
<h2 id="metadata">Metadata</h2>
<p><strong>Metadata</strong> consists of:</p>
<ul>
<li>A long indicating the number of metadata key/value pairs.</li>
<li>For each pair, a string key and bytes value.</li>
</ul>
<p>All metadata properties that start with &ldquo;trevni.&rdquo; are reserved.</p>
<h3 id="file-metadata">File Metadata</h3>
<p>The following file metadata properties are defined:</p>
<ul>
<li><strong>trevni.codec</strong> the name of the default compression codec used to compress blocks, as a string. Implementations are required to support the &ldquo;null&rdquo; codec. Optional. If absent, it is assumed to be &ldquo;null&rdquo;. Codecs are described in more detail below.</li>
<li><strong>trevni.checksum</strong> the name of the checksum algorithm used in this file, as a string. Implementations are required to support the &ldquo;crc-32” checksum. Optional. If absent, it is assumed to be &ldquo;null&rdquo;. Checksums are described in more detail below.</li>
</ul>
<h3 id="column-metadata">Column Metadata</h3>
<p>The following column metadata properties are defined:</p>
<ul>
<li>trevni.codec the name of the compression codec used to compress the blocks of this column, as a string. Implementations are required to support the &ldquo;null&rdquo; codec. Optional. If absent, it is assumed to be &ldquo;null&rdquo;. Codecs are described in more detail below.</li>
<li>trevni.name the name of the column, as a string. Required.</li>
<li>trevni.type the type of data in the column. One of the type names above. Required.</li>
<li>trevni.values if present, indicates that the initial value of each block in this column will be stored in the block’s descriptor. Not permitted for array columns or columns that specify a parent.</li>
<li>trevni.array if present, indicates that each row in this column contains a sequence of values of the named type rather than just a single value. An integer length precedes each sequence of values indicating the count of values in the sequence.</li>
<li>trevni.parent if present, the name of an array column whose lengths are also used by this column. Thus values of this column are sequences but no lengths are stored in this column.</li>
</ul>
<p>For example, consider the following row, as JSON, where all values are primitive types, but one has multiple values.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">566</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">23423234234</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#34;from&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;foo@bar.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;to&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;bar@baz.com&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bang@foo.com&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;Hi!&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The columns for this might be specified as:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">name=id</span>       <span style="color:#a40000">type=int</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=date</span>     <span style="color:#a40000">type=long</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=from</span>     <span style="color:#a40000">type=string</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=to</span>       <span style="color:#a40000">type=string</span>  <span style="color:#a40000">array=</span><span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=content</span>  <span style="color:#a40000">type=string</span> 
</span></span></code></pre></div><p>If a row contains an array of records, e.g. &ldquo;received&rdquo; in the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">566</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">23423234234</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#34;from&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;foo@bar.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;to&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;bar@baz.com&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bang@foo.com&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;Hi!&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#34;received&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[{</span><span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">234234234234</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;192.168.0.0.1&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>             <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">234234545645</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;192.168.0.0.2&#34;</span><span style="color:#000;font-weight:bold">}]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then one can define a parent column followed by a column for each field in the record, adding the following columns:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">name=received</span>  <span style="color:#a40000">type=</span><span style="color:#204a87;font-weight:bold">null</span>    <span style="color:#a40000">array=</span><span style="color:#204a87;font-weight:bold">true</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=date</span>      <span style="color:#a40000">type=long</span>    <span style="color:#a40000">parent=received</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=host</span>      <span style="color:#a40000">type=string</span>  <span style="color:#a40000">parent=received</span>
</span></span></code></pre></div><p>If an array value itself contains an array, e.g. the &ldquo;sigs&rdquo; below:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;id&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">566</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">23423234234</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#34;from&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;foo@bar.com&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;to&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;bar@baz.com&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;bang@foo.com&#34;</span><span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;content&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;Hi!&#34;</span>
</span></span><span style="display:flex;"><span> <span style="color:#4e9a06">&#34;received&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[{</span><span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">234234234234</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;192.168.0.0.1&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;sigs&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[{</span><span style="color:#204a87;font-weight:bold">&#34;algo&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;weak&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;value&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;0af345de&#34;</span><span style="color:#000;font-weight:bold">}]},</span>
</span></span><span style="display:flex;"><span>             <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;date&#34;</span><span style="color:#a40000">=</span><span style="color:#0000cf;font-weight:bold">234234545645</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;host&#34;</span><span style="color:#a40000">=</span><span style="color:#4e9a06">&#34;192.168.0.0.2&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>              <span style="color:#204a87;font-weight:bold">&#34;sigs&#34;</span><span style="color:#a40000">=</span><span style="color:#000;font-weight:bold">[]}]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>Then a parent column may be defined that itself has a parent column.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">name=sigs</span>   <span style="color:#a40000">type=</span><span style="color:#204a87;font-weight:bold">null</span>    <span style="color:#a40000">array=</span><span style="color:#204a87;font-weight:bold">true</span>  <span style="color:#a40000">parent=received</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=algo</span>   <span style="color:#a40000">type=string</span>              <span style="color:#a40000">parent=sigs</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">name=value</span>  <span style="color:#a40000">type=string</span>              <span style="color:#a40000">parent=sigs</span>
</span></span></code></pre></div><h3 id="block-metadata">Block Metadata</h3>
<p>No block metadata properties are currently defined.</p>
<h2 id="file-format">File Format</h2>
<p>A <strong>file</strong> consists of:</p>
<ul>
<li>A file header, followed by</li>
<li>one or more columns.</li>
</ul>
<p>A <strong>file header</strong> consists of:</p>
<ul>
<li>Four bytes, ASCII &lsquo;T&rsquo;, &lsquo;r&rsquo;, &lsquo;v&rsquo;, followed by 0x02.</li>
<li>a fixed64 indicating the number of rows in the file</li>
<li>a fixed32 indicating the number of columns in the file</li>
<li>file metadata.</li>
<li>for each column, its column metadata</li>
<li>for each column, its starting position in the file as a fixed64.</li>
</ul>
<p>A <strong>column</strong> consists of:</p>
<ul>
<li>A fixed32 indicating the number of blocks in this column.</li>
<li>For each block, a block descriptor</li>
<li>One or more blocks.</li>
</ul>
<p>A <strong>block descriptor</strong> consists of:</p>
<ul>
<li>A fixed32 indicating the number of rows in the block</li>
<li>A fixed32 indicating the size in bytes of the block before the codec is applied (excluding checksum).</li>
<li>A fixed32 indicating the size in bytes of the block after the codec is applied (excluding checksum).</li>
<li>If this column’s metadata declares it to include values, the first value in the column, serialized according to this column&rsquo;s type.</li>
</ul>
<p>A <strong>block</strong> consists of:</p>
<ul>
<li>The serialized column values. If a column is an array column then value sequences are preceded by their length, as an int. If a codec is specified, the values and lengths are compressed by that codec.</li>
<li>The checksum, as determined by the file metadata.</li>
</ul>
<h2 id="codecs">Codecs</h2>
<h3 id="null">null</h3>
<p>The &ldquo;null&rdquo; codec simply passes data through uncompressed.</p>
<h3 id="deflate">deflate</h3>
<p>The &ldquo;deflate&rdquo; codec writes the data block using the deflate algorithm as specified in RFC 1951.</p>
<h3 id="snappy">snappy</h3>
<p>The &ldquo;snappy&rdquo; codec uses Google&rsquo;s Snappy compression library.</p>
<h2 id="checksum-algorithms">Checksum algorithms</h2>
<h3 id="null-1">null</h3>
<p>The &ldquo;null&rdquo; checksum contains zero bytes.</p>
<h3 id="crc-32">crc-32</h3>
<p>Each &ldquo;crc-32&rdquo; checksum contains the four bytes of an ISO 3309 CRC-32 checksum of the uncompressed block data as a fixed32.</p>
<h2 id="type-mappings">Type Mappings</h2>
<p>We define a standard mapping for how types defined in various serialization systems are represented in a column file. Records from these systems are shredded into columns. When records are nested, a depth-first recursive walk can assign a separate column for each primitive value.</p>
<p><strong>Avro</strong></p>
<p><strong>Protocol Buffers</strong></p>
<p><strong>Thrift</strong></p>
<h2 id="implementation-notes">Implementation Notes</h2>
<p>Some possible techniques for writing column files include:</p>
<ol>
<li>Use a standard ~100MB block, buffer in memory up to the block size, then flush the file directly to HDFS. A single reduce task might create multiple output files. The namenode requires memory proportional to the number of names and blocks*replication. This would increase the number of names but not blocks, so this should still be much better than a file per column.</li>
<li>Spill each column to a separate local, temporary file then, when the file is closed, append these files, writing a single file to HDFS whose block size is set to be that of the entire file. This would be a bit slower than and may have trouble when the local disk is full, but it would better use HDFS namespace and further reduce seeks when processing columns whose values are small.</li>
<li>Use a separate mapreduce job to convert row-major files to column-major. The map output would output a by (row#, column#, value) tuple, partitioned by row# but sorted by column# then row#. The reducer could directly write the column file. But the column file format would need to be changed to write counts, descriptors, etc. at the end of files rather than at the front.</li>
</ol>
<p>(1) is the simplest to implement and most implementations should start with it.</p>
<h2 id="references">References</h2>
<p>CIF <a href="https://arxiv.org/pdf/1105.4252.pdf">Column-Oriented Storage Techniques for MapReduce</a>, Floratou, Patel, Shekita, &amp; Tata, VLDB 2011.</p>
<p>DREMEL Dremel: <a href="https://static.googleusercontent.com/media/research.google.com/en//pubs/archive/36632.pdf">Interactive Analysis of Web-Scale Datasets</a>, Melnik, Gubarev, Long, Romer, Shivakumar, &amp; Tolton, VLDB 2010.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-e82727a687286aede19db3df523a207a">5 - MapReduce guide</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<p>Avro provides a convenient way to represent complex data structures within a Hadoop MapReduce job. Avro data can be used as both input to and output from a MapReduce job, as well as the intermediate format. The example in this guide uses Avro data for all three, but it&rsquo;s possible to mix and match; for instance, MapReduce can be used to aggregate a particular field in an Avro record.</p>
<p>This guide assumes basic familiarity with both Hadoop MapReduce and Avro. See the <a href="https://hadoop.apache.org/docs/current/">Hadoop documentation</a> and the <a href="./getting-started-java/">Avro getting started guide</a> for introductions to these projects. This guide uses the old MapReduce API (<code>org.apache.hadoop.mapred</code>).</p>
<h2 id="setup">Setup</h2>
<p>The code from this guide is included in the Avro docs under examples/mr-example. The example is set up as a Maven project that includes the necessary Avro and MapReduce dependencies and the Avro Maven plugin for code generation, so no external jars are needed to run the example. In particular, the POM includes the following dependencies:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.7.4<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-mapred<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.7.4<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;dependency&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.hadoop<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>hadoop-core<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.1.0<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/dependency&gt;</span>
</span></span></code></pre></div><p>And the following plugin:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-maven-plugin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;version&gt;</span>1.7.4<span style="color:#204a87;font-weight:bold">&lt;/version&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;phase&gt;</span>generate-sources<span style="color:#204a87;font-weight:bold">&lt;/phase&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;goal&gt;</span>schema<span style="color:#204a87;font-weight:bold">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;configuration&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;sourceDirectory&gt;</span>${project.basedir}/../<span style="color:#204a87;font-weight:bold">&lt;/sourceDirectory&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;outputDirectory&gt;</span>${project.basedir}/src/main/java/<span style="color:#204a87;font-weight:bold">&lt;/outputDirectory&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/configuration&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/plugin&gt;</span>
</span></span></code></pre></div><p>Alternatively, Avro jars can be downloaded directly from the Apache Avro™ Releases page. The relevant Avro jars for this guide are avro-1.7.4.jar and avro-mapred-1.7.4.jar, as well as avro-tools-1.7.4.jar for code generation and viewing Avro data files as JSON. In addition, you will need to install Hadoop in order to use MapReduce.</p>
<h2 id="example-colorcount">Example: ColorCount</h2>
<p>Below is a simple example of a MapReduce that uses Avro. This example can be found in the Avro docs under examples/mr-example/src/main/java/example/ColorCount.java. We&rsquo;ll go over the specifics of what&rsquo;s going on in subsequent sections.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">package</span> <span style="color:#000">example</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">java.io.IOException</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.Schema.Type</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.avro.mapred.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.conf.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.fs.Path</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.mapred.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">org.apache.hadoop.util.*</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">import</span> <span style="color:#000">example.avro.User</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCount</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">Configured</span> <span style="color:#204a87;font-weight:bold">implements</span> <span style="color:#000">Tool</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroMapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>      <span style="color:#8f5902;font-style:italic">// We need this check because the User.favorite_color field has type [&#34;string&#34;, &#34;null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>      <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroReducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                                            <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CharSequence</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                       <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Integer</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">length</span> <span style="color:#ce5c00;font-weight:bold">!=</span> <span style="color:#0000cf;font-weight:bold">2</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">err</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">println</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;Usage: ColorCount &lt;input path&gt; &lt;output path&gt;&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">JobConf</span> <span style="color:#000">conf</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">JobConf</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">getConf</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">ColorCount</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setJobName</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;colorcount&#34;</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FileInputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputPaths</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">]));</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FileOutputFormat</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputPath</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Path</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">[</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">]));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapperClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setReducerClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountReducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// Note that AvroJob.setInputSchema and AvroJob.setOutputSchema set
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// relevant config options such as input/output format, map output
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#8f5902;font-style:italic">// classes, and output key class.
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">SCHEMA$</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPairSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STRING</span><span style="color:#ce5c00;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>        <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">INT</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">JobClient</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">runJob</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">return</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">main</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">String</span><span style="color:#ce5c00;font-weight:bold">[]</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Exception</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">res</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">ToolRunner</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">run</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Configuration</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">ColorCount</span><span style="color:#ce5c00;font-weight:bold">(),</span> <span style="color:#000">args</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">System</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">exit</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">res</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>ColorCount reads in data files containing User records, defined in examples/user.avsc, and counts the number of instances of each favorite color. (This example draws inspiration from the canonical WordCount MapReduce application.) The User schema is defined as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;namespace&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;example.avro&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;record&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;User&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span> <span style="color:#204a87;font-weight:bold">&#34;fields&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;name&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">,</span>  <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;int&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]},</span>
</span></span><span style="display:flex;"><span>     <span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;type&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span><span style="color:#4e9a06">&#34;string&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;null&#34;</span><span style="color:#000;font-weight:bold">]}</span>
</span></span><span style="display:flex;"><span> <span style="color:#000;font-weight:bold">]</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>This schema is compiled into the <em>User</em> class used by <em>ColorCount</em> via the Avro Maven plugin (see <em>examples/mr-example/pom.xml</em> for how this is set up).</p>
<p><em>ColorCountMapper</em> essentially takes a <em>User</em> as input and extracts the User&rsquo;s favorite color, emitting the key-value pair <code>&lt;favoriteColor, 1&gt;</code>. <em>ColorCountReducer</em> then adds up how many occurrences of a particular favorite color were emitted, and outputs the result as a Pair record. These Pairs are serialized to an Avro data file.</p>
<h2 id="running-colorcount">Running ColorCount</h2>
<p>The <em>ColorCount</em> application is provided as a Maven project in the Avro docs under <em>examples/mr-example</em>. To build the project, including the code generation of the User schema, run:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn compile
</span></span></code></pre></div><p>Next, run GenerateData to create an Avro data file, input/users.avro, containing 20 Users with favorite colors chosen randomly from a list:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn exec:java -q -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.GenerateData
</span></span></code></pre></div><p>Besides creating the data file, GenerateData prints the JSON representations of the Users generated to stdout, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;green&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;purple&#34;</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span><span style="color:#204a87;font-weight:bold">&#34;name&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;user&#34;</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_number&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">&#34;favorite_color&#34;</span><span style="color:#000;font-weight:bold">:</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">...</span>
</span></span></code></pre></div><p>Now we&rsquo;re ready to run ColorCount. We specify our freshly-generated input folder as the input path and output as our output folder (note that MapReduce will not start a job if the output folder already exists):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>mvn exec:java -q -Dexec.mainClass<span style="color:#ce5c00;font-weight:bold">=</span>example.ColorCount -Dexec.args<span style="color:#ce5c00;font-weight:bold">=</span><span style="color:#4e9a06">&#34;input output&#34;</span>
</span></span></code></pre></div><p>Once ColorCount completes, checking the contents of the new output directory should yield the following:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ ls output/
</span></span><span style="display:flex;"><span>part-00000.avro  _SUCCESS
</span></span></code></pre></div><p>You can check the contents of the generated Avro file using the avro-tools jar:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ java -jar /path/to/avro-tools-1.7.4.jar tojson output/part-00000.avro
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 3, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;blue&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 7, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;green&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 1, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;orange&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 3, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;purple&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;red&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span><span style="color:#4e9a06">&#34;value&#34;</span>: 2, <span style="color:#4e9a06">&#34;key&#34;</span>: <span style="color:#4e9a06">&#34;yellow&#34;</span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Now let&rsquo;s go over the ColorCount example in detail.</p>
<h2 id="avromapper">AvroMapper</h2>
<p>The easiest way to use Avro data files as input to a MapReduce job is to subclass <code>AvroMapper</code>. An <code>AvroMapper</code> defines a <code>map</code> function that takes an Avro datum as input and outputs a key/value pair represented as a Pair record. In the ColorCount example, ColorCountMapper is an AvroMapper that takes a User as input and outputs a <code>Pair&lt;CharSequence, Integer&gt;&gt;</code>, where the CharSequence key is the user&rsquo;s favorite color and the Integer value is 1.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountMapper</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroMapper</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">map</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">User</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">CharSequence</span> <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#000">user</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getFavoriteColor</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span><span style="display:flex;"><span>    <span style="color:#8f5902;font-style:italic">// We need this check because the User.favorite_color field has type [&#34;string&#34;, &#34;null&#34;]
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>    <span style="color:#204a87;font-weight:bold">if</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">==</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">color</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#4e9a06">&#34;none&#34;</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">color</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>In order to use our AvroMapper, we must call AvroJob.setMapperClass and AvroJob.setInputSchema.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setMapperClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountMapper</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setInputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">User</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">SCHEMA$</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p>Note that <code>AvroMapper</code> does not implement the <code>Mapper</code> interface. Under the hood, the specified Avro data files are deserialized into AvroWrappers containing the actual data, which are processed by a Mapper that calls the configured AvroMapper&rsquo;s map function. AvroJob.setInputSchema sets up the relevant configuration parameters needed to make this happen, thus you should not need to call <code>JobConf.setMapperClass</code>, <code>JobConf.setInputFormat</code>, <code>JobConf.setMapOutputKeyClass</code>, <code>JobConf.setMapOutputValueClass</code>, or <code>JobConf.setOutputKeyComparatorClass</code>.</p>
<h2 id="avroreducer">AvroReducer</h2>
<p>Analogously to AvroMapper, an AvroReducer defines a reducer function that takes the key/value types output by an AvroMapper (or any mapper that outputs Pairs) and outputs a key/value pair represented a Pair record. In the ColorCount example, ColorCountReducer is an AvroReducer that takes the CharSequence key representing a favorite color and the <code>Iterable&lt;Integer&gt;</code> representing the counts for that color (they should all be 1 in this example) and adds up the counts.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">static</span> <span style="color:#204a87;font-weight:bold">class</span> <span style="color:#000">ColorCountReducer</span> <span style="color:#204a87;font-weight:bold">extends</span> <span style="color:#000">AvroReducer</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                                                          <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#5c35cc;font-weight:bold">@Override</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">public</span> <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">reduce</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">CharSequence</span> <span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Iterable</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#000">AvroCollector</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;&gt;</span> <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>                     <span style="color:#000">Reporter</span> <span style="color:#000">reporter</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">IOException</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">for</span> <span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Integer</span> <span style="color:#000">value</span> <span style="color:#ce5c00;font-weight:bold">:</span> <span style="color:#000">values</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>      <span style="color:#000">sum</span> <span style="color:#ce5c00;font-weight:bold">+=</span> <span style="color:#000">value</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">collector</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">collect</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">new</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">CharSequence</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Integer</span><span style="color:#ce5c00;font-weight:bold">&gt;(</span><span style="color:#000">key</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">sum</span><span style="color:#ce5c00;font-weight:bold">));</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>In order to use our AvroReducer, we must call AvroJob.setReducerClass and AvroJob.setOutputSchema.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setReducerClass</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">ColorCountReducer</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">class</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span><span style="color:#000">AvroJob</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">setOutputSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">conf</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">Pair</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">getPairSchema</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">STRING</span><span style="color:#ce5c00;font-weight:bold">),</span>
</span></span><span style="display:flex;"><span>                                                 <span style="color:#000">Schema</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">create</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">Type</span><span style="color:#ce5c00;font-weight:bold">.</span><span style="color:#c4a000">INT</span><span style="color:#ce5c00;font-weight:bold">)));</span>
</span></span></code></pre></div><p>Note that AvroReducer does not implement the Reducer interface. The intermediate Pairs output by the mapper are split into AvroKeys and AvroValues, which are processed by a Reducer that calls the configured AvroReducer&rsquo;s reduce function. AvroJob.setOutputSchema sets up the relevant configuration parameters needed to make this happen, thus you should not need to call JobConf.setReducerClass, JobConf.setOutputFormat, JobConf.setOutputKeyClass, JobConf.setMapOutputKeyClass, JobConf.setMapOutputValueClass, or JobConf.setOutputKeyComparatorClass.</p>
<h2 id="learning-more">Learning more</h2>
<p>It&rsquo;s possible to mix AvroMappers and AvroReducers with non-Avro Mappers and Reducers. See the org.apache.avro.mapred documentation for more details. There is also a org.apache.avro.mapreduce package for use with the new MapReduce API (org.apache.hadoop.mapreduce). It&rsquo;s also possible to implement your own Mappers and Reducers directly using the public classes provided in these libraries. See the AvroWordCount application, found under examples/mr-example/src/main/java/example/AvroWordCount.java in the Avro documentation, for an example of implementing a Reducer that outputs Avro data.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-7c053ceb7ab566384ea3cf84bbf5dd53">6 - IDL Language</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="introduction">Introduction</h2>
<p>This document defines Avro IDL, a higher-level language for authoring Avro schemata. Before reading this document, you should have familiarity with the concepts of schemata and protocols, as well as the various primitive and complex types available in Avro.</p>
<h2 id="overview">Overview</h2>
<h3 id="purpose">Purpose</h3>
<p>The aim of the Avro IDL language is to enable developers to author schemata in a way that feels more similar to common programming languages like Java, C++, or Python. Additionally, the Avro IDL language may feel more familiar for those users who have previously used the interface description languages (IDLs) in other frameworks like Thrift, Protocol Buffers, or CORBA.</p>
<h3 id="usage">Usage</h3>
<p>Each Avro IDL file defines a single Avro Protocol, and thus generates as its output a JSON-format Avro Protocol file with extension .avpr.</p>
<p>To convert a <em>.avdl</em> file into a <em>.avpr</em> file, it may be processed by the <code>idl</code> tool. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-shell" data-lang="shell"><span style="display:flex;"><span>$ java -jar avroj-tools.jar idl src/test/idl/input/namespaces.avdl /tmp/namespaces.avpr
</span></span><span style="display:flex;"><span>$ head /tmp/namespaces.avpr
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;protocol&#34;</span> : <span style="color:#4e9a06">&#34;TestNamespace&#34;</span>,
</span></span><span style="display:flex;"><span>  <span style="color:#4e9a06">&#34;namespace&#34;</span> : <span style="color:#4e9a06">&#34;avro.test.protocol&#34;</span>,
</span></span></code></pre></div><p>The <code>idl</code> tool can also process input to and from <em>stdin</em> and <em>stdout</em>. See <code>idl --help</code> for full usage information.</p>
<p>A Maven plugin is also provided to compile .avdl files. To use it, add something like the following to your pom.xml:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-xml" data-lang="xml"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;build&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;plugins&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;plugin&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;groupId&gt;</span>org.apache.avro<span style="color:#204a87;font-weight:bold">&lt;/groupId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;artifactId&gt;</span>avro-maven-plugin<span style="color:#204a87;font-weight:bold">&lt;/artifactId&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;executions&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;execution&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;goals&gt;</span>
</span></span><span style="display:flex;"><span>            <span style="color:#204a87;font-weight:bold">&lt;goal&gt;</span>idl-protocol<span style="color:#204a87;font-weight:bold">&lt;/goal&gt;</span>
</span></span><span style="display:flex;"><span>          <span style="color:#204a87;font-weight:bold">&lt;/goals&gt;</span>
</span></span><span style="display:flex;"><span>        <span style="color:#204a87;font-weight:bold">&lt;/execution&gt;</span>
</span></span><span style="display:flex;"><span>      <span style="color:#204a87;font-weight:bold">&lt;/executions&gt;</span>
</span></span><span style="display:flex;"><span>    <span style="color:#204a87;font-weight:bold">&lt;/plugin&gt;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&lt;/plugins&gt;</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&lt;/build&gt;</span>
</span></span></code></pre></div><h2 id="defining-a-protocol-in-avro-idl">Defining a Protocol in Avro IDL</h2>
<p>An Avro IDL file consists of exactly one protocol definition. The minimal protocol is defined by the following code:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">protocol</span> <span style="color:#000">MyProtocol</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>This is equivalent to (and generates) the following JSON protocol definition:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">&#34;protocol&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#4e9a06">&#34;MyProtocol&#34;</span><span style="color:#000;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;types&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">[</span> <span style="color:#000;font-weight:bold">],</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">&#34;messages&#34;</span> <span style="color:#000;font-weight:bold">:</span> <span style="color:#000;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span><span style="color:#000;font-weight:bold">}</span>
</span></span></code></pre></div><p>The namespace of the protocol may be changed using the @namespace annotation:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@namespace</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;mynamespace&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">protocol</span> <span style="color:#000">MyProtocol</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>This notation is used throughout Avro IDL as a way of specifying properties for the annotated element, as will be described later in this document.</p>
<p>Protocols in Avro IDL can contain the following items:</p>
<ul>
<li>Imports of external protocol and schema files.</li>
<li>Definitions of named schemata, including records, errors, enums, and fixeds.</li>
<li>Definitions of RPC messages</li>
</ul>
<h2 id="imports">Imports</h2>
<p>Files may be imported in one of three formats:</p>
<ul>
<li>
<p>An IDL file may be imported with a statement like:</p>
<p><code>import idl &quot;foo.avdl&quot;;</code></p>
</li>
<li>
<p>A JSON protocol file may be imported with a statement like:</p>
<p><code>import protocol &quot;foo.avpr&quot;;</code></p>
</li>
<li>
<p>A JSON schema file may be imported with a statement like:</p>
<p><code>import schema &quot;foo.avsc&quot;;</code></p>
</li>
</ul>
<p>Messages and types in the imported file are added to this file&rsquo;s protocol.</p>
<p>Imported file names are resolved relative to the current IDL file.</p>
<h2 id="defining-an-enumeration">Defining an Enumeration</h2>
<p>Enums are defined in Avro IDL using a syntax similar to C or Java:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">Suit</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">SPADES</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">DIAMONDS</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">CLUBS</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">HEARTS</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Note that, unlike the JSON format, anonymous enums cannot be defined.</p>
<h2 id="defining-a-fixed-length-field">Defining a Fixed Length Field</h2>
<p>Fixed fields are defined using the following syntax:</p>
<pre tabindex="0"><code>fixed MD5(16);
</code></pre><p>This example defines a fixed-length type called MD5 which contains 16 bytes.</p>
<h2 id="defining-records-and-errors">Defining Records and Errors</h2>
<p>Records are defined in Avro IDL using a syntax similar to a struct definition in C:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">Employee</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">boolean</span> <span style="color:#000">active</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#204a87;font-weight:bold">true</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">long</span> <span style="color:#000">salary</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>The above example defines a record with the name “Employee” with three fields.</p>
<p>To define an error, simply use the keyword <em>error</em> instead of <em>record</em>. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">error</span> <span style="color:#000">Kaboom</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#000">explanation</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">result_code</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#0000cf;font-weight:bold">1</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Each field in a record or error consists of a type and a name, optional property annotations and an optional default value.</p>
<p>A type reference in Avro IDL must be one of:</p>
<ul>
<li>A primitive type</li>
<li>A logical type</li>
<li>A named schema defined prior to this usage in the same Protocol</li>
<li>A complex type (array, map, or union)</li>
</ul>
<h3 id="primitive-types">Primitive Types</h3>
<p>The primitive types supported by Avro IDL are the same as those supported by Avro&rsquo;s JSON format. This list includes <em>int</em>, <em>long</em>, <em>string</em>, <em>boolean</em>, <em>float</em>, <em>double</em>, <em>null</em>, and <em>bytes</em>.</p>
<h3 id="references-to-named-schemata">References to Named Schemata</h3>
<p>If a named schema has already been defined in the same Avro IDL file, it may be referenced by name as if it were a primitive type:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">Card</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">Suit</span> <span style="color:#000">suit</span><span style="color:#ce5c00;font-weight:bold">;</span> <span style="color:#8f5902;font-style:italic">// refers to the enum Card defined above
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">number</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><h3 id="default-values">Default Values</h3>
<p>Default values for fields may be optionally specified by using an equals sign after the field name followed by a JSON expression indicating the default value. This JSON is interpreted as described in the <a href="/docs/1.11.1/specification/#schema-record">spec</a>.</p>
<h3 id="complex-types">Complex Types</h3>
<h4 id="arrays">Arrays</h4>
<p>Array types are written in a manner that will seem familiar to C++ or Java programmers. An array of any type t is denoted <code>array&lt;t&gt;</code>. For example, an array of strings is denoted <code>array&lt;string&gt;</code>, and a multidimensional array of Foo records would be <code>array&lt;array&lt;Foo&gt;&gt;</code>.</p>
<h4 id="maps">Maps</h4>
<p>Map types are written similarly to array types. An array that contains values of type t is written <code>map&lt;t&gt;</code>. As in the JSON schema format, all maps contain <code>string</code>-type keys.</p>
<h4 id="unions">Unions</h4>
<p>Union types are denoted as union { typeA, typeB, typeC, &hellip; }. For example, this record contains a string field that is optional (unioned with null):</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">RecordWithUnion</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">union</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#000">string</span> <span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#000">optionalString</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Note that the same restrictions apply to Avro IDL unions as apply to unions defined in the JSON format; namely, a record may not contain multiple elements of the same type.</p>
<h2 id="defining-rpc-messages">Defining RPC Messages</h2>
<p>The syntax to define an RPC message within a Avro IDL protocol is similar to the syntax for a method declaration within a C header file or a Java interface. To define an RPC message add which takes two arguments named <em>foo</em> and <em>bar</em>, returning an <em>int</em>, simply include the following definition within the protocol:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">foo</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">bar</span> <span style="color:#ce5c00;font-weight:bold">=</span> <span style="color:#0000cf;font-weight:bold">0</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p>Message arguments, like record fields, may specify default values.</p>
<p>To define a message with no response, you may use the alias <em>void</em>, equivalent to the Avro <em>null</em> type:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">logMessage</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">string</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span></code></pre></div><p>If you have previously defined an error type within the same protocol, you may declare that a message can throw this error using the syntax:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">goKaboom</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">Kaboom</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span></code></pre></div><p>To define a one-way message, use the keyword <code>oneway</code> after the parameter list, for example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">fireAndForget</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">string</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">oneway</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span></code></pre></div><h2 id="other-language-features">Other Language Features</h2>
<h3 id="comments">Comments</h3>
<p>All Java-style comments are supported within a Avro IDL file. Any text following <em>//</em> on a line is ignored, as is any text between <em>/*</em> and <em>*/</em>, possibly spanning multiple lines.</p>
<p>Comments that begin with <em>/**</em> are used as the documentation string for the type or field definition that follows the comment.</p>
<h3 id="escaping-identifiers">Escaping Identifiers</h3>
<p>Occasionally, one will need to use a reserved language keyword as an identifier. In order to do so, backticks (`) may be used to escape the identifier. For example, to define a message with the literal name error, you may write:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#204a87;font-weight:bold">void</span> <span style="color:#a40000">`</span><span style="color:#000">error</span><span style="color:#a40000">`</span><span style="color:#ce5c00;font-weight:bold">();</span>
</span></span></code></pre></div><p>This syntax is allowed anywhere an identifier is expected.</p>
<h3 id="annotations-for-ordering-and-namespaces">Annotations for Ordering and Namespaces</h3>
<p>Java-style annotations may be used to add additional properties to types and fields throughout Avro IDL.</p>
<p>For example, to specify the sort order of a field within a record, one may use the <code>@order</code> annotation before the field name as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">MyRecord</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#5c35cc;font-weight:bold">@order</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ascending&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">myAscendingSortField</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#5c35cc;font-weight:bold">@order</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;descending&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>  <span style="color:#000">myDescendingField</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#5c35cc;font-weight:bold">@order</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ignore&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">myIgnoredField</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>A field&rsquo;s type may also be preceded by annotations, e.g.:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">MyRecord</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#5c35cc;font-weight:bold">@java</span><span style="color:#ce5c00;font-weight:bold">-</span><span style="color:#000">class</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;java.util.ArrayList&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span> <span style="color:#000">array</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#000">string</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">myStrings</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Similarly, a <code>@namespace</code> annotation may be used to modify the namespace when defining a named schema. For example:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@namespace</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;org.apache.avro.firstNamespace&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span><span style="color:#000">protocol</span> <span style="color:#000">MyProto</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#5c35cc;font-weight:bold">@namespace</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;org.apache.avro.someOtherNamespace&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">record</span> <span style="color:#000">Foo</span> <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">record</span> <span style="color:#000">Bar</span> <span style="color:#ce5c00;font-weight:bold">{}</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>will define a protocol in the <em>firstNamespace</em> namespace. The record <em>Foo</em> will be defined in <em>someOtherNamespace</em> and <em>Bar</em> will be defined in <em>firstNamespace</em> as it inherits its default from its container.</p>
<p>Type and field aliases are specified with the <code>@aliases</code> annotation as follows:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@aliases</span><span style="color:#ce5c00;font-weight:bold">([</span><span style="color:#4e9a06">&#34;org.old.OldRecord&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;org.ancient.AncientRecord&#34;</span><span style="color:#ce5c00;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span><span style="color:#000">record</span> <span style="color:#000">MyRecord</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#5c35cc;font-weight:bold">@aliases</span><span style="color:#ce5c00;font-weight:bold">([</span><span style="color:#4e9a06">&#34;oldField&#34;</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#4e9a06">&#34;ancientField&#34;</span><span style="color:#ce5c00;font-weight:bold">])</span> <span style="color:#000">myNewField</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Some annotations like those listed above are handled specially. All other annotations are added as properties to the protocol, message, schema or field.</p>
<h2 id="complete-example">Complete Example</h2>
<p>The following is a complete example of a Avro IDL file that shows most of the above features:</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-java" data-lang="java"><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">/**
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> * An example protocol in Avro IDL
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic">
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"> */</span>
</span></span><span style="display:flex;"><span><span style="color:#5c35cc;font-weight:bold">@namespace</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;org.apache.avro.test&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#000">protocol</span> <span style="color:#000">Simple</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#5c35cc;font-weight:bold">@aliases</span><span style="color:#ce5c00;font-weight:bold">([</span><span style="color:#4e9a06">&#34;org.foo.KindOf&#34;</span><span style="color:#ce5c00;font-weight:bold">])</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">enum</span> <span style="color:#000">Kind</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">FOO</span><span style="color:#ce5c00;font-weight:bold">,</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BAR</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#8f5902;font-style:italic">// the bar enum value
</span></span></span><span style="display:flex;"><span><span style="color:#8f5902;font-style:italic"></span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">BAZ</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span> 
</span></span><span style="display:flex;"><span>  
</span></span><span style="display:flex;"><span>  <span style="color:#000">fixed</span> <span style="color:#000">MD5</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#0000cf;font-weight:bold">16</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">record</span> <span style="color:#000">TestRecord</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>     <span style="color:#5c35cc;font-weight:bold">@order</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;ignore&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">string</span> <span style="color:#000">name</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>   <span style="color:#5c35cc;font-weight:bold">@order</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#4e9a06">&#34;descending&#34;</span><span style="color:#ce5c00;font-weight:bold">)</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">Kind</span> <span style="color:#000">kind</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">MD5</span> <span style="color:#000">hash</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">union</span> <span style="color:#ce5c00;font-weight:bold">{</span> <span style="color:#000">MD5</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#ce5c00;font-weight:bold">}</span> <span style="color:#5c35cc;font-weight:bold">@aliases</span><span style="color:#ce5c00;font-weight:bold">([</span><span style="color:#4e9a06">&#34;hash&#34;</span><span style="color:#ce5c00;font-weight:bold">])</span> <span style="color:#000">nullableHash</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">array</span><span style="color:#ce5c00;font-weight:bold">&lt;</span><span style="color:#204a87;font-weight:bold">long</span><span style="color:#ce5c00;font-weight:bold">&gt;</span> <span style="color:#000">arrayOfLongs</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">error</span> <span style="color:#000">TestError</span> <span style="color:#ce5c00;font-weight:bold">{</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#000">string</span> <span style="color:#000">message</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#ce5c00;font-weight:bold">}</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">string</span> <span style="color:#000">hello</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">string</span> <span style="color:#000">greeting</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">TestRecord</span> <span style="color:#000">echo</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">TestRecord</span> <span style="color:#a40000">`</span><span style="color:#000">record</span><span style="color:#a40000">`</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">add</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arg1</span><span style="color:#ce5c00;font-weight:bold">,</span> <span style="color:#204a87;font-weight:bold">int</span> <span style="color:#000">arg2</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#000">bytes</span> <span style="color:#000">echoBytes</span><span style="color:#ce5c00;font-weight:bold">(</span><span style="color:#000">bytes</span> <span style="color:#000">data</span><span style="color:#ce5c00;font-weight:bold">);</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#a40000">`</span><span style="color:#000">error</span><span style="color:#a40000">`</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#204a87;font-weight:bold">throws</span> <span style="color:#000">TestError</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  <span style="color:#204a87;font-weight:bold">void</span> <span style="color:#000">ping</span><span style="color:#ce5c00;font-weight:bold">()</span> <span style="color:#000">oneway</span><span style="color:#ce5c00;font-weight:bold">;</span>
</span></span><span style="display:flex;"><span><span style="color:#ce5c00;font-weight:bold">}</span>
</span></span></code></pre></div><p>Additional examples may be found in the Avro source tree under the <code>src/test/idl/input</code> directory.</p>
<p>Apache Avro, Avro, Apache, and the Avro and Apache logos are trademarks of The Apache Software Foundation.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-4b8d3266c94eea5257ceff0ddb5b9b56">7 - SASL profile</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="introduction">Introduction</h2>
<p>SASL (<a href="https://www.ietf.org/rfc/rfc2222.txt">RFC 2222</a>) provides a framework for authentication and security of network protocols. Each protocol that uses SASL is meant to define a SASL profile. This document provides a SASL profile for connection-based Avro RPC.</p>
<h2 id="overview">Overview</h2>
<p>SASL negotiation proceeds as a series of message interactions over a connection between a client and server using a selected SASL mechanism. The client starts this negotiation by sending its chosen mechanism name with an initial (possibly empty) message. Negotiation proceeds with the exchange of messages until either side indicates success or failure. The content of the messages is mechanism-specific. If the negotiation succeeds, then the session can proceed over the connection, otherwise it must be abandoned.</p>
<p>Some mechanisms continue to process session data after negotiation (e.g., encrypting it), while some specify that further session data is transmitted unmodified.</p>
<h2 id="negotiation">Negotiation</h2>
<h3 id="commands">Commands</h3>
<p>Avro SASL negotiation uses four one-byte commands.</p>
<ul>
<li>0: START Used in a client&rsquo;s initial message.</li>
<li>1: CONTINUE Used while negotiation is ongoing.</li>
<li>2: FAIL Terminates negotiation unsuccessfully.</li>
<li>3: COMPLETE Terminates negotiation successfully.</li>
</ul>
<p>The format of a START message is:</p>
<p><code>| 0 | 4-byte mechanism name length | mechanism name | 4-byte payload length | payload data |</code></p>
<p>The format of a CONTINUE message is:</p>
<p><code>| 1 | 4-byte payload length | payload data |</code></p>
<p>The format of a FAIL message is:</p>
<p><code>| 2 | 4-byte message length | UTF-8 message |</code></p>
<p>The format of a COMPLETE message is:</p>
<p><code>| 3 | 4-byte payload length | payload data |</code></p>
<h3 id="process">Process</h3>
<p>Negotiation is initiated by a client sending a START command containing the client&rsquo;s chosen mechanism name and any mechanism-specific payload data.</p>
<p>The server and client then interchange some number (possibly zero) of CONTINUE messages. Each message contains payload data that is processed by the security mechanism to generate the next message.</p>
<p>Once either the client or server send a FAIL message then negotiation has failed. UTF-8-encoded text is included in the failure message. Once either a FAIL message has been sent or received, or any other error occurs in the negotiation, further communication on this connection must cease.</p>
<p>Once either the client or server send a COMPLETE message then negotiation has completed successfully. Session data may now be transmitted over the connection until it is closed by either side.</p>
<h2 id="session-data">Session Data</h2>
<p>If no SASL QOP (quality of protection) is negotiated, then all subsequent writes to/reads over this connection are written/read unmodified. In particular, messages use Avro <a href="#Message+Framing">framing</a>, and are of the form:</p>
<p><code>| 4-byte frame length | frame data | ... | 4 zero bytes |</code></p>
<p>If a SASL QOP is negotiated, then it must be used by the connection for all subsequent messages. This is done by wrapping each non-empty frame written using the security mechanism and unwrapping each non-empty frame read. The length written in each non-empty frame is the length of the wrapped data. Complete frames must be passed to the security mechanism for unwrapping. Unwrapped data is then passed to the application as the content of the frame.</p>
<p>If at any point processing fails due to wrapping, unwrapping or framing errors, then all further communication on this connection must cease.</p>
<h2 id="anonymous-mechanism">Anonymous Mechanism</h2>
<p>The SASL anonymous mechanism (<a href="https://www.ietf.org/rfc/rfc2222.txt">RFC 2245</a>) is quite simple to implement. In particular, an initial anonymous request may be prefixed by the following static sequence:</p>
<p><code>| 0 | 0009 | ANONYMOUS | 0000 |</code></p>
<p>If a server uses the anonymous mechanism, it should check that the mechanism name in the start message prefixing the first request received is &lsquo;ANONYMOUS&rsquo;, then simply prefix its initial response with a COMPLETE message of:</p>
<p><code>| 3 | 0000 |</code></p>
<p>If an anonymous server recieves some other mechanism name, then it may respond with a FAIL message as simple as:</p>
<p><code>| 2 | 0000 |</code></p>
<p>Note that the anonymous mechanism need add no additional round-trip messages between client and server. The START message can be piggybacked on the initial request and the COMPLETE or FAIL message can be piggybacked on the initial response.</p>
<p>Apache Avro, Avro, Apache, and the Avro and Apache logos are trademarks of The Apache Software Foundation.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-fb10f23b4405ac464a4717347b11735f">8 - Wiki</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<p>The Wiki page can be found <a href="https://cwiki.apache.org/confluence/display/HADOOP2/Avro/">here</a>.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  
    
    
	
    

<div class="td-content" style="page-break-before: always">
    
	<h1 id="pg-c6272d220cb97ce59bb49530b65880bf">9 - FAQ</h1>
    
	<!--

 Licensed to the Apache Software Foundation (ASF) under one
 or more contributor license agreements.  See the NOTICE file
 distributed with this work for additional information
 regarding copyright ownership.  The ASF licenses this file
 to you under the Apache License, Version 2.0 (the
 "License"); you may not use this file except in compliance
 with the License.  You may obtain a copy of the License at

   https://www.apache.org/licenses/LICENSE-2.0

 Unless required by applicable law or agreed to in writing,
 software distributed under the License is distributed on an
 "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
 KIND, either express or implied.  See the License for the
 specific language governing permissions and limitations
 under the License.

-->
<h2 id="what-is-avro">What is Avro?</h2>
<p>Avro is a data serialization system.</p>
<p>Avro provides:</p>
<ul>
<li>Rich data structures.</li>
<li>A compact, fast, binary data format.</li>
<li>A container file, to store persistent data.</li>
<li>Remote procedure call (RPC).</li>
<li>Simple integration with dynamic languages. Code generation is not required to read or write data files nor to use or implement RPC protocols. Code generation as an optional optimization, only worth implementing for statically typed languages.</li>
</ul>
<h2 id="how-can-i-get-started-quickly-with-avro">How can I get started quickly with Avro?</h2>
<p>Check out the <a href="https://github.com/phunt/avro-rpc-quickstart">Quick Start Guide</a>.</p>
<h2 id="how-do-i-statically-compile-a-schema-or-protocol-into-generated-code">How do I statically compile a schema or protocol into generated code?</h2>
<h3 id="in-java">In Java</h3>
<ul>
<li>Add the avro jar, the jackson-mapper-asl.jar and jackson-core-asl.jar to your CLASSPATH.</li>
<li>Run java org.apache.avro.specific.SpecificCompiler <json file>.</li>
</ul>
<p>This appears to be out of date, the SpecificCompiler requires two arguments, presumably an input and and output file, but it isn&rsquo;t clear that this does.</p>
<p>Or use the Schema or Protocol Ant tasks. Avro&rsquo;s build.xml provides examples of how these are used.</p>
<p>Lastly, you can also use the &ldquo;avro-tools&rdquo; jar which ships with an Avro release. Just use the &ldquo;compile (schema|protocol)&rdquo; command.</p>
<h2 id="how-are-strings-represented-in-java">How are Strings represented in Java?</h2>
<p>They use <a href="https://avro.apache.org/docs/current/api/java/org/apache/avro/util/Utf8.html">org.apache.avro.util.Utf8</a>, not java.lang.String.</p>
<h2 id="more-generally-how-do-avro-types-map-to-java-types">More generally, how do Avro types map to Java types?</h2>
<p>The mappings are documented in the package javadoc for <a href="https://avro.apache.org/docs/1.7.6/gettingstartedjava.html#Defining+a+schema">generic</a>, <a href="https://avro.apache.org/docs/current/api/java/org/apache/avro/specific/package-summary.html#package_description">specific</a> and <a href="https://avro.apache.org/docs/current/api/java/org/apache/avro/reflect/package-summary.html#package_description">reflect</a> API.</p>
<h2 id="what-is-the-purpose-of-the-sync-marker-in-the-object-file-format">What is the purpose of the sync marker in the object file format?</h2>
<p>From Doug Cutting:</p>
<p>HDFS splits files into blocks, and mapreduce runs a map task for each block. When the task starts, it needs to be able to seek into the file to the start of the block process through the block&rsquo;s end. If the file were, e.g., a gzip file, this would not be possible, since gzip files must be decompressed from the start. One cannot seek into the middle of a gzip file and start decompressing. So Hadoop&rsquo;s SequenceFile places a marker periodically (~64k) in the file at record and compression boundaries, where processing can be sensibly started. Then, when a map task starts processing an HDFS block, it finds the first marker after the block&rsquo;s start and continues through the first marker in the next block of the file. This requires a bit of non-local access (~0.1%). Avro&rsquo;s data file uses the same method as SequenceFile.</p>
<h2 id="why-isnt-every-value-in-avro-nullable">Why isn&rsquo;t every value in Avro nullable?</h2>
<p>When serialized, if any value may be null then it must be noted that it
is non-null, adding at least a bit to the size of every value stored and
corresponding computational costs to create this bit on write and
interpret it on read. These costs are wasted when values may not in
fact be null, as is the case in many datasets. In Avro such costs are
only paid when values may actually be null.</p>
<p>Also, allowing values to be null is a well-known source of errors. In
Avro, a value declared as non-null will always be non-null and programs
need not test for null values when processing it nor will they ever fail
for lack of such tests.</p>
<p>Tony Hoare calls his invention of null references his &ldquo;Billion Dollar
Mistake&rdquo;.</p>
<p><a href="http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake">http://qconlondon.com/london-2009/presentation/Null+References:+The+Billion+Dollar+Mistake</a></p>
<p>Also note that in some programming languages not all values are permitted to be null. For example, in Java, values of type boolean, byte, short, char, int, float, long, and double may not be null.</p>
<h2 id="how-can-i-serialize-directly-tofrom-a-byte-array">How can I serialize directly to/from a byte array?</h2>
<p>As pointed out in the specification, Avro data should always be stored with its <a href="https://avro.apache.org/docs/1.7.6/spec.html#Data+Serialization">schema</a>. The Avro provided classes <a href="https://avro.apache.org/docs/1.7.6/api/java/org/apache/avro/file/DataFileWriter.html">DataFileWriter</a>, <a href="https://avro.apache.org/docs/1.7.6/api/java/org/apache/avro/file/DataFileReader.html">DataFileReader</a>, and <a href="https://avro.apache.org/docs/1.7.6/api/java/org/apache/avro/file/DataFileStream.html">DataFileStream</a> all ensure this by serializing the Schema in a container header. In some special cases, such as when implementing a new storage system or writing unit tests, you may need to write and read directly with the bare Avro serialized values. The following examples use <a href="https://cwiki.apache.org/confluence/display/AVRO/FAQ#FAQ-InJava">code generated for Java</a> from an Avro Schema, specifically the <a href="https://avro.apache.org/docs/1.7.6/gettingstartedjava.html#Defining+a+schema">User example</a> from the Quickstart guide.</p>
<h3 id="serializing-to-a-byte-array">Serializing to a byte array</h3>
<p>This example takes a User object and returns a newly allocated byte array with the Avro serialization of that user.</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">ByteArrayOutputStream</span> <span style="color:#a40000">out</span> <span style="color:#a40000">=</span> <span style="color:#a40000">new</span> <span style="color:#a40000">ByteArrayOutputStream();</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">BinaryEncoder</span> <span style="color:#a40000">encoder</span> <span style="color:#a40000">=</span> <span style="color:#a40000">EncoderFactory.get().binaryEncoder(out,</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#a40000">);</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">DatumWriter&lt;User&gt;</span> <span style="color:#a40000">writer</span> <span style="color:#a40000">=</span> <span style="color:#a40000">new</span> <span style="color:#a40000">SpecificDatumWriter&lt;User&gt;(User.getClassSchema());</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">writer.write(user,</span> <span style="color:#a40000">encoder);</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">encoder.flush();</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">out.close();</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">byte</span><span style="color:#000;font-weight:bold">[]</span> <span style="color:#a40000">serializedBytes</span> <span style="color:#a40000">=</span> <span style="color:#a40000">out.toByteArray();</span>
</span></span></code></pre></div><h3 id="deserializing-from-a-byte-array">Deserializing from a byte array</h3>
<p>This example takes a byte array containing the Avro serialization of a user and returns a User object.SpecificDatumReader<User> reader = new SpecificDatumReader<User>(User.getClassSchema());</p>
<div class="highlight"><pre tabindex="0" style="background-color:#f8f8f8;-moz-tab-size:4;-o-tab-size:4;tab-size:4;"><code class="language-json" data-lang="json"><span style="display:flex;"><span><span style="color:#a40000">Decoder</span> <span style="color:#a40000">decoder</span> <span style="color:#a40000">=</span> <span style="color:#a40000">DecoderFactory.get().binaryDecoder(bytes,</span> <span style="color:#204a87;font-weight:bold">null</span><span style="color:#a40000">);</span>
</span></span><span style="display:flex;"><span><span style="color:#a40000">User</span> <span style="color:#a40000">user</span> <span style="color:#a40000">=</span> <span style="color:#a40000">reader.read(</span><span style="color:#204a87;font-weight:bold">null</span><span style="color:#a40000">,</span> <span style="color:#a40000">decoder);</span>
</span></span></code></pre></div><p><strong>Note</strong>: If you are serializing or deserializing in a loop or as a method, you should be reusing objects, readers and/or writers. Check the JavaDoc to see how to reuse the objects.</p>

</div>



    
      
  
  
  
  

  
  

  

    
	
  



          </main>
        </div>
      </div>
      


<footer class="bg-dark py-5 row d-print-none">
  <div class="container-fluid2 mx-sm-5">
    <div class="row">
      <div class="col-4 col-sm-3 text-xs-center order-sm-2">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="User mailing list" aria-label="User mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:user@avro.apache.org" aria-label="User mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Twitter" aria-label="Twitter">
    <a class="text-white" target="_blank" rel="noopener" href="https://twitter.com/ApacheAvro" aria-label="Twitter">
      <i class="fab fa-twitter"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Stack Overflow" aria-label="Stack Overflow">
    <a class="text-white" target="_blank" rel="noopener" href="https://stackoverflow.com/questions/tagged/avro" aria-label="Stack Overflow">
      <i class="fab fa-stack-overflow"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-4 col-sm-3 text-right text-xs-center order-sm-3">
        
        
        
<ul class="list-inline mb-0">
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="GitHub" aria-label="GitHub">
    <a class="text-white" target="_blank" rel="noopener" href="https://github.com/apache/avro" aria-label="GitHub">
      <i class="fab fa-github"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Issues" aria-label="Issues">
    <a class="text-white" target="_blank" rel="noopener" href="https://issues.apache.org/jira/projects/AVRO/issues" aria-label="Issues">
      <i class="fab fa-jira"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Chat with other project developers at Slack" aria-label="Chat with other project developers at Slack">
    <a class="text-white" target="_blank" rel="noopener" href="https://the-asf.slack.com/" aria-label="Chat with other project developers at Slack">
      <i class="fab fa-slack"></i>
    </a>
  </li>
  
  <li class="list-inline-item mx-2 h3" data-toggle="tooltip" data-placement="top" title="Developer mailing list" aria-label="Developer mailing list">
    <a class="text-white" target="_blank" rel="noopener" href="mailto:dev@avro.apache.org" aria-label="Developer mailing list">
      <i class="fa fa-envelope"></i>
    </a>
  </li>
  
</ul>

        
        
      </div>
      <div class="col-10 col-sm-3 text-center py-2 order-sm-2">
        <a href="https://www.apache.org/"><small class="text-white">&copy; 2023 The Apache Software Foundation </small></a><small class="text-white">All Rights Reserved</small>
	
      <p><small class="text-white">Apache Avro, Avro&trade;, Apache&reg;, and the Apache feather logo are either registered trademarks or trademarks of The Apache Software Foundation.</small></p>
      </div>
      <div class="col-5 col-sm-3 order-sm-2">
          <a href="https://www.apache.org/events/current-event.html"><img src="https://www.apache.org/events/current-event-234x60.png"></a>
      </div>
    </div>
  </div>
</footer>


    </div>
    <script src="https://cdn.jsdelivr.net/npm/popper.js@1.16.1/dist/umd/popper.min.js"
    integrity="sha384-9/reFTGAW83EW2RDu2S0VKaIzap3H66lZH81PoYlFhbGU+6BZp6G7niu735Sk7lN"
    crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js"
    integrity="sha512-UR25UO94eTnCVwjbXozyeVd6ZqpaAE9naiEUBK/A+QDbfSTQFhPGj5lOR6d8tsgbBk84Ggb5A3EkjsOgPRPcKA=="
    crossorigin="anonymous"></script>





<script src='/js/tabpane-persist.js'></script>


















<script src="/js/main.min.aa9f4c5dae6a98b2c46277f4c56f1673a2b000d1756ce4ffae93784cab25e6d5.js" integrity="sha256-qp9MXa5qmLLEYnf0xW8Wc6KwANF1bOT/rpN4TKsl5tU=" crossorigin="anonymous"></script>



<script src='/js/prism.js'></script>



  </body>
</html>
